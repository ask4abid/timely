<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Giant world clock display for any location">
    <title>TIMELY – Your Personal Global Timekeeper</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TIMELY">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- iOS Specific -->
    <meta name="format-detection" content="telephone=no">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23667eea'/><text y='60' x='50' text-anchor='middle' font-size='60' fill='white'>🕐</text></svg>">
    
    <!-- Android Specific -->
    <link rel="manifest" href="manifest.json">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="src/css/simple-styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🕐</text></svg>">
    
    <!-- City Cards Custom Styles -->
    <style>
        /* Mobile-First Base Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            -moz-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        /* Mobile Safe Area Support for iPhone X+ */
        .main-content {
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
        }
        
        /* Enhanced Mobile Touch Targets */
        button, .city-card, .search-result-item, .quick-action-btn {
            min-height: 44px; /* iOS minimum touch target */
            min-width: 44px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* Mobile Typography Optimization */
        .location-name {
            font-size: clamp(1.2rem, 4vw, 1.8rem);
            line-height: 1.2;
        }
        
        .location-country {
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            line-height: 1.3;
        }
        
        .main-time {
            font-size: clamp(2.5rem, 12vw, 5rem);
            letter-spacing: clamp(1px, 0.5vw, 3px);
        }
        
        .main-date {
            font-size: clamp(1rem, 3.5vw, 1.4rem);
        }
        
        /* Subtle Footer */
        .app-footer {
            text-align: center;
            padding: 16px 0;
            margin-top: 40px;
            font-size: 12px;
            color: #888;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 400;
            line-height: 1.4;
            opacity: 1;
            transition: opacity 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(136, 136, 136, 0.1);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            width: 100%;
            position: relative;
            z-index: 10;
            border-radius: 8px 8px 0 0;
        }
        
        .app-footer:hover {
            opacity: 1;
        }
        
        .app-footer .heart {
            color: #ff6b6b;
            animation: heartbeat 2s ease-in-out infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Dark mode support for footer */
        @media (prefers-color-scheme: dark) {
            .app-footer {
                background: rgba(30, 30, 30, 0.95);
                border-top: 1px solid rgba(136, 136, 136, 0.2);
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
            }
        }
        
        /* Mobile optimization for footer */
        @media (max-width: 768px) {
            .app-footer {
                font-size: 11px;
                padding: 12px 0;
            }
        }
        
        /* Mobile-Optimized Hero Section */
        .hero-time-section {
            padding: clamp(10px, 3vw, 20px);
            margin: 0;
        }
        
        .giant-clock-display {
            padding: clamp(15px, 4vw, 30px);
            text-align: center;
        }
        
        /* Mobile Location Header - Optimized Layout */
        .location-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(2px, 1vw, 4px);
            margin-bottom: clamp(4px, 2vw, 8px);
            justify-content: center;
        }

        /* Flag + City Name Row */
        .location-name-row {
            display: flex;
            align-items: center;
            gap: clamp(6px, 2vw, 10px);
            justify-content: center;
        }
        
        .location-flag {
            font-size: clamp(2rem, 6vw, 2.8rem);
            flex-shrink: 0; /* Prevent flag from shrinking */
            line-height: 1;
            display: inline-block;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
            animation: gentle-pulse 3s ease-in-out infinite;
            /* Enhanced visibility and emoji support */
            font-family: "Segoe UI Emoji", "Apple Color Emoji", "Noto Color Emoji", "Segoe UI", system-ui, sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            min-width: 50px;
            min-height: 50px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        /* Fallback for when emojis don't work */
        .location-flag::after {
            content: attr(data-country-code);
            position: absolute;
            bottom: -8px;
            right: -8px;
            font-size: 10px;
            background: #4299e1;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
            font-family: system-ui, sans-serif;
        }
        
        /* Switch Location Button - Mobile Optimized */
        .switch-location-btn {
            padding: clamp(8px, 2vw, 12px) clamp(12px, 4vw, 20px);
            font-size: clamp(0.8rem, 3vw, 1rem);
            border-radius: clamp(8px, 2vw, 12px);
            margin-bottom: clamp(10px, 3vw, 15px);
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: auto;
            max-width: 100%;
        }
        
        /* CSS Variables for theming */
        :root {
            --modal-bg: #ffffff;
            --modal-text: #1f2937;
            --modal-border: #e5e7eb;
            --modal-shadow: rgba(0, 0, 0, 0.1);
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --success-color: #10b981;
            --error-color: #ef4444;
            --secondary-text: #6b7280;
            --surface-bg: #f9fafb;
            --selected-bg: #eff6ff;
            --selected-border: #3b82f6;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --modal-bg: #1f2937;
                --modal-text: #f9fafb;
                --modal-border: #374151;
                --modal-shadow: rgba(0, 0, 0, 0.3);
                --secondary-text: #9ca3af;
                --surface-bg: #111827;
                --selected-bg: #1e3a8a;
                --selected-border: #60a5fa;
            }
        }

        /* CSS Variables for Dark Mode Support */
        :root {
            --modal-bg: #ffffff;
            --modal-text: #1f2937;
            --modal-text-secondary: #6b7280;
            --modal-border: #e5e7eb;
            --modal-shadow: rgba(0, 0, 0, 0.1);
            --search-bg: #f9fafb;
            --search-border: #d1d5db;
            --search-focus: #3b82f6;
            --button-primary: #3b82f6;
            --button-primary-hover: #2563eb;
            --button-secondary: #f3f4f6;
            --button-secondary-hover: #e5e7eb;
            --selected-bg: #dbeafe;
            --selected-border: #3b82f6;
            --tap-highlight: rgba(59, 130, 246, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --modal-bg: #1f2937;
                --modal-text: #f9fafb;
                --modal-text-secondary: #9ca3af;
                --modal-border: #374151;
                --modal-shadow: rgba(0, 0, 0, 0.25);
                --search-bg: #374151;
                --search-border: #4b5563;
                --search-focus: #60a5fa;
                --button-primary: #3b82f6;
                --button-primary-hover: #2563eb;
                --button-secondary: #374151;
                --button-secondary-hover: #4b5563;
                --selected-bg: #1e3a8a;
                --selected-border: #60a5fa;
                --tap-highlight: rgba(96, 165, 250, 0.1);
            }
        }

        /* Mobile-First Location Picker Modal */
        .location-picker-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .location-picker-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .location-picker-modal {
            width: 100%;
            height: 92vh;
            max-height: 92vh;
            background: var(--modal-bg);
            border-radius: 20px 20px 0 0;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 20px var(--modal-shadow);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }

        .location-picker-overlay.active .location-picker-modal {
            transform: translateY(0);
        }

        /* Modal Header with Back Button */
        .modal-header {
            background: var(--modal-bg);
            padding: 16px 20px 12px;
            border-bottom: 1px solid var(--modal-border);
            display: flex;
            align-items: center;
            gap: 16px;
            min-height: 56px;
            position: relative;
        }

        .modal-back-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--button-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: var(--modal-text);
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-back-btn:hover {
            background: var(--button-secondary-hover);
            transform: scale(1.05);
        }

        .modal-back-btn:active {
            transform: scale(0.95);
            background: var(--tap-highlight);
        }

        .modal-header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--modal-text);
            margin: 0;
            letter-spacing: -0.01em;
        }

        .modal-header {
            flex-shrink: 0;
            box-shadow: 0 1px 4px var(--modal-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            min-height: 56px;
        }

        .modal-back-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: var(--surface-bg);
            border: 1px solid var(--modal-border);
            color: var(--modal-text);
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        .modal-back-btn:hover,
        .modal-back-btn:focus {
            background: var(--modal-border);
            transform: scale(0.98);
        }

        .modal-back-btn:active {
            transform: scale(0.95);
        }

        .modal-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--modal-text);
            margin: 0;
            flex: 1;
        }

        .modal-close-btn {
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 40px;
            min-height: 40px;
        }
        
        .modal-close-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-close-btn:active {
            transform: scale(0.95);
            background: #d1d5db;
        }
        
        /* Compact Search Section */
        .search-section {
            padding: 16px 20px;
            background: var(--modal-bg);
            border-bottom: 1px solid var(--modal-border);
        }

        .search-input-container {
            position: relative;
            margin-bottom: 12px;
        }

        .search-input {
            width: 100%;
            height: 48px;
            border: 2px solid #6366f1;
            border-radius: 14px;
            padding: 0 48px 0 44px;
            font-size: 17px;
            color: #222;
            background: #fff;
            transition: all 0.2s ease;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(99,102,241,0.08);
        }

        .search-input:focus {
            border-color: #6366f1;
            background: #fff;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
        }

        .search-input::placeholder {
            color: #6366f1;
            opacity: 1;
        }

        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--modal-text-secondary);
            pointer-events: none;
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--modal-text-secondary);
            border: none;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .search-clear-btn:hover {
            background: var(--modal-text);
        }

        /* Current Location Button */
        .current-location-btn {
            width: 100%;
            height: 56px;
            background: var(--button-primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .current-location-btn:hover {
            background: var(--button-primary-hover);
            transform: translateY(-1px);
        }

        .current-location-btn:active {
            transform: scale(0.98);
        }

        .current-location-btn .loading-spinner {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Body - Scrollable Content */
        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Selected Location Display */
        .selected-location {
            background: var(--selected-bg);
            border: 1px solid var(--selected-border);
            border-radius: 12px;
            padding: 16px 20px;
            margin: 16px 20px 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .selected-location-flag {
            font-size: 24px;
            line-height: 1;
        }

        .selected-location-info {
            flex: 1;
        }

        .selected-location-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--modal-text);
            margin: 0 0 2px 0;
        }

        .selected-location-country {
            font-size: 14px;
            color: var(--modal-text-secondary);
            margin: 0;
        }

        .selected-location-check {
            font-size: 20px;
            color: var(--selected-border);
        }

        /* Location Cards */
        .location-card {
            min-height: 56px;
                color: #ffcc00; /* Changed to a gold color */
            border: 1px solid var(--modal-border);
            border-radius: 12px;
            margin: 8px 20px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .location-card:hover {
            background: var(--button-secondary);
            border-color: var(--search-border);
            transform: scale(0.98);
        }

        .location-card:active {
            transform: scale(0.96);
            background: var(--tap-highlight);
        }

        .location-flag {
            font-size: 20px;
            flex-shrink: 0;
            line-height: 1;
        }

        .location-info {
            flex: 1;
            min-width: 0;
        }

        .location-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--modal-text);
            margin: 0 0 2px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-country {
            font-size: 13px;
            color: var(--modal-text-secondary);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-time {
            font-size: 14px;
            font-weight: 500;
            color: var(--modal-text-secondary);
            flex-shrink: 0;
        }

        /* Section Headers */
        .section-header {
            padding: 20px 20px 8px;
            background: var(--modal-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--modal-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0;
        }

        /* Accessibility and Focus States */
        .location-card:focus,
        .modal-back-btn:focus,
        .current-location-btn:focus {
            outline: 2px solid var(--search-focus);
            outline-offset: 2px;
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .location-picker-modal,
            .location-card,
            .modal-back-btn,
            .current-location-btn,
            .search-input {
                transition: none;
            }
            
            .current-location-btn .loading-spinner {
                animation: none;
            }
        }
        
        .search-input:focus {
            border-color: #3b82f6;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #6b7280;
            pointer-events: none;
        }
        
        /* Detect Location Button */
        .detect-location-btn {
            width: 100%;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .detect-location-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .detect-location-btn:active {
            transform: translateY(0);
        }
        
        .detect-location-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .detect-location-btn .icon {
            font-size: 18px;
        }
        
        /* Loading State */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal Body - Scrollable content */
        .modal-body {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 0;
            position: relative;
        }
                /* Sticky search bar for mobile */
                @media (max-width: 600px) {
                    .search-input-container {
                        position: sticky;
                        top: 0;
                        background: #fff;
                        z-index: 10;
                        padding-top: 8px;
                        padding-bottom: 8px;
                    }
                    .search-input, #citySearchInput {
                        font-size: 18px !important;
                        padding: 12px 40px 12px 16px !important;
                        width: 100%;
                        border-radius: 8px;
                        color: #222 !important;
                        background: #fff !important;
                    }
                    .search-clear-btn {
                        right: 12px;
                        top: 50%;
                        transform: translateY(-50%);
                        font-size: 22px;
                        width: 36px;
                        height: 36px;
                        display: flex !important;
                    }
                    .search-results-container {
                        max-height: 60vh;
                        overflow-y: auto;
                        margin-top: 12px;
                    }
                    .search-result-card {
                        padding: 16px;
                        font-size: 16px;
                        border-radius: 10px;
                        margin-bottom: 10px;
                    }
                }
        
        /* Popular Locations Container */
        .popular-locations {
            padding-top: 8px; /* Extra spacing from sticky search section */
        }
        
        /* Search Results */
        .search-results {
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
        }
        
        .search-results-header {
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .search-results-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Location Cards */
        .location-card {
            min-height: 48px;
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .location-card:hover {
            background: #f8fafc;
            border-color: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .location-card:active {
            transform: translateY(0);
            background: #e5e7eb;
        }
        
        .location-info {
            flex: 1;
            min-width: 0;
        }
        
        .location-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 2px 0;
            line-height: 1.2;
        }
        
        .location-country {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
            line-height: 1.2;
        }
        
        .location-time {
            font-size: 12px;
            font-weight: 500;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }
        
        /* Section Headers */
        .section-header {
            position: sticky;
            top: 0;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 24px;
            z-index: 98;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Location Sections */
        .location-section {
            padding: 16px 24px;
        }
        
        .location-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        /* Empty State */
        .empty-state {
            padding: 48px 24px;
            text-align: center;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin: 0 0 8px 0;
        }
        
        .empty-state-description {
            font-size: 14px;
            margin: 0;
        }
        
        /* Tablet and Desktop Responsiveness */
        @media (min-width: 768px) {
            .location-picker-overlay {
                align-items: center;
                padding: 24px;
            }
            
            .location-picker-modal {
                width: 90%;
                max-width: 600px;
                height: auto;
                max-height: 80vh;
                border-radius: 24px;
                transform: scale(0.95);
            }
            
            .location-picker-overlay.active .location-picker-modal {
                transform: scale(1);
            }
            
            .modal-header {
                border-radius: 24px 24px 0 0;
                padding: 16px 20px 12px;
            }
            
            .search-section {
                padding: 20px 32px;
                top: 65px; /* Adjusted for mobile header height */
            }
            
            .location-section {
                padding: 16px 32px;
            }
            
            .section-header {
                padding: 12px 32px;
            }
            
            .location-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 12px;
            }
        }
        
        @media (min-width: 1024px) {
            .location-picker-modal {
                max-width: 700px;
            }
            
            .location-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .location-picker-modal {
                background: #1f2937;
                color: #f9fafb;
            }
            
            .modal-header {
                background: #1f2937;
                border-bottom-color: #374151;
            }
            
            .modal-title {
                color: #f9fafb;
            }
            
            .modal-close-btn {
                background: #374151;
                color: #9ca3af;
            }
            
            .modal-close-btn:hover {
                background: #4b5563;
                color: #d1d5db;
            }
            
            .search-section {
                background: #1f2937;
                border-bottom-color: #374151;
            }
            
            .search-input {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            
            .search-input:focus {
                background: #4b5563;
                border-color: #60a5fa;
            }
            
            .search-input::placeholder {
                color: #9ca3af;
            }
            
            .search-icon {
                color: #9ca3af;
            }
            
            .detect-location-btn {
                background: linear-gradient(135deg, #3b82f6, #1e40af);
            }
            
            .search-results {
                background: #111827;
                border-bottom-color: #374151;
            }
            
            .search-results-header {
                color: #9ca3af;
            }
            
            .location-card {
                background: #374151;
                border-color: #4b5563;
            }
            
            .location-card:hover {
                background: #4b5563;
                border-color: #6b7280;
            }
            
            .location-card:active {
                background: #6b7280;
            }
            
            .location-name {
                color: #f9fafb;
            }
            
            .location-country {
                color: #9ca3af;
            }
            
            .location-time {
                background: rgba(59, 130, 246, 0.2);
                color: #60a5fa;
            }
            
            .section-header {
                background: #111827;
                border-bottom-color: #374151;
            }
            
            .section-title {
                color: #e5e7eb;
            }
            
            .empty-state-title {
                color: #e5e7eb;
            }
        }
        
        /* Mobile Search Input */
        .city-search-input {
            padding: clamp(12px, 4vw, 16px) clamp(40px, 12vw, 50px) clamp(12px, 4vw, 16px) clamp(15px, 4vw, 20px);
            font-size: clamp(14px, 4vw, 16px);
            border-radius: clamp(20px, 5vw, 25px);
            min-height: 50px;
        }
        
        /* Mobile City Cards Grid */
        .cities-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 16px 0;
        }
        
        /* Individual City Card */
        .city-card {
            background: rgba(255,255,255,0.95);
            border: 1.5px solid rgba(99,102,241,0.13);
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
        }
        
        .city-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-color: #6366f1;
        }
        
        .city-card:active {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
            border-color: #38b2ac;
        }
        
        /* Selection feedback */
        .city-card.selected {
            background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
            border-color: #38b2ac;
            box-shadow: 0 8px 25px rgba(56, 178, 172, 0.3);
        }
        
        /* Card Header */
        .city-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .city-flag {
            font-size: 18px;
            display: inline-block;
        }
        
        .city-time {
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 14px;
            color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(66, 153, 225, 0.2);
        }
        
        /* Card Body */
        .city-card-body {
            margin-bottom: 12px;
        }
        
        .city-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 4px 0;
            font-family: 'Rajdhani', sans-serif;
        }
        
        .city-country {
            font-size: 13px;
            color: #64748b;
            margin: 2px 0 0 0;
            font-weight: 500;
        }
        
        /* Card Footer */
        .city-card-footer {
            border-top: 1px solid #e2e8f0;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .timezone-info {
            font-size: 11px;
            color: #a0aec0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quick-favorite-btn {
            background: linear-gradient(45deg, #f59e0b, #f97316);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(245, 158, 11, 0.3);
        }

        .quick-favorite-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .quick-favorite-btn:active {
            transform: translateY(0);
        }

        .quick-favorite-btn.added {
            background: linear-gradient(45deg, #10b981, #34d399);
            animation: favoriteAdded 0.5s ease;
        }

        @keyframes favoriteAdded {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Continent Section Styling */
        .continent-section {
            margin-bottom: 32px;
        }
        
        .continent-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin: 0 0 16px 0;
            font-family: 'Rajdhani', sans-serif;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 8px;
        }
        
        /* Enhanced Mobile-First Responsive Design */
        
        /* Small Mobile Devices (320px - 480px) */
        @media (max-width: 480px) {
            .cities-cards-grid {
                grid-template-columns: 1fr;
                gap: clamp(8px, 3vw, 12px);
                padding: 0 clamp(5px, 2vw, 10px);
            }
            
            .city-card {
                padding: clamp(10px, 3vw, 15px);
                border-radius: clamp(8px, 2vw, 12px);
                margin-bottom: clamp(8px, 2vw, 10px);
            }
            
            .city-card-header {
                margin-bottom: clamp(8px, 2vw, 10px);
            }
            
            .city-flag {
                font-size: clamp(18px, 5vw, 22px);
            }
            
            .city-time {
                font-size: clamp(10px, 3vw, 12px);
                padding: clamp(2px, 1vw, 4px) clamp(4px, 2vw, 6px);
            }
            
            .city-name {
                font-size: clamp(12px, 4vw, 14px);
                line-height: 1.3;
            }
            
            .city-country {
                font-size: clamp(10px, 3vw, 11px);
            }
            
            .quick-favorite-btn {
                padding: clamp(6px, 2vw, 8px) clamp(8px, 3vw, 12px);
                font-size: clamp(8px, 2.5vw, 10px);
                min-height: 32px;
                min-width: 32px;
            }
            
            /* Mobile Hero Section */
            .hero-time-section {
                padding: clamp(5px, 2vw, 15px);
            }
            
            .switch-location-btn {
                width: 90%;
                max-width: 280px;
                padding: clamp(10px, 3vw, 14px);
                font-size: clamp(12px, 3.5vw, 14px);
            }
            
            .location-header {
                margin-bottom: clamp(15px, 4vw, 20px);
            }
            
            /* Mobile Modal Adjustments */
            .location-picker-modal {
                border-radius: clamp(15px, 4vw, 20px) clamp(15px, 4vw, 20px) 0 0;
                max-height: 95vh;
                max-height: 95dvh;
            }
            
            .modal-header {
                padding: clamp(12px, 4vw, 20px);
            }
            
            .search-section {
                top: 60px; /* Adjusted for small mobile header */
                padding: clamp(12px, 4vw, 16px);
            }
            
            .modal-heading {
                font-size: clamp(18px, 5vw, 22px);
            }
            
            .modal-subtitle {
                font-size: clamp(12px, 3.5vw, 14px);
            }
            
            .close-modal {
                width: clamp(32px, 8vw, 40px);
                height: clamp(32px, 8vw, 40px);
                font-size: clamp(18px, 5vw, 24px);
            }
        }
        
        /* Medium Mobile/Large Mobile (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .cities-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: clamp(12px, 3vw, 16px);
            }
            
            .city-card {
                padding: clamp(12px, 3vw, 16px);
            }
            
            .city-flag {
                font-size: clamp(20px, 4vw, 24px);
            }
            
            .city-time {
                font-size: clamp(12px, 3vw, 14px);
                padding: clamp(3px, 1vw, 4px) clamp(6px, 2vw, 8px);
            }
            
            .city-name {
                font-size: clamp(14px, 3.5vw, 16px);
            }
            
            .switch-location-btn {
                width: auto;
                max-width: 320px;
            }
        }
        
        /* Tablet Portrait (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .cities-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 16px;
            }
            
            .main-content {
                padding: 0 clamp(20px, 3vw, 40px);
            }
        }
        
        /* Touch-Specific Styles for All Mobile Devices */
        @media (hover: none) and (pointer: coarse) {
            .city-card:hover {
                transform: none;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border-color: #e2e8f0;
            }
            
            .city-card:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            .quick-favorite-btn:hover {
                transform: none;
                box-shadow: 0 1px 4px rgba(245, 158, 11, 0.3);
            }
            
            .quick-favorite-btn:active {
                transform: scale(0.95);
            }
            
            .search-result-item:hover {
                transform: none;
                border-color: transparent;
                background: rgba(255, 255, 255, 0.8);
                box-shadow: none;
            }
            
            .search-result-item:active {
                background: rgba(255, 255, 255, 1);
                transform: scale(0.98);
            }
        }
        
        /* Landscape Orientation Optimization */
        @media (orientation: landscape) and (max-height: 600px) {
            .hero-time-section {
                padding: clamp(5px, 1vh, 10px) clamp(10px, 2vw, 20px);
            }
            
            .main-time {
                font-size: clamp(2rem, 8vh, 4rem);
                margin-bottom: clamp(5px, 1vh, 10px);
            }
            
            .main-date {
                font-size: clamp(0.9rem, 2.5vh, 1.2rem);
                margin-bottom: clamp(5px, 1vh, 15px);
            }
            
            .location-picker-modal {
                max-height: 90vh;
                max-height: 90dvh;
            }
        }
        
        /* Dark mode support (if needed later) */
        @media (prefers-color-scheme: dark) {
            .city-card {
                background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
                border-color: #4a5568;
            }
            
            .city-card:hover {
                border-color: #667eea;
            }
            
            .city-name {
                color: #e2e8f0;
            }
            
            .city-country {
                color: #a0aec0;
            }
            
            .city-card-footer {
                border-top-color: #4a5568;
            }
            
            .continent-title {
                color: #e2e8f0;
                border-bottom-color: #4a5568;
            }
        }

        /* Giant Clock Location Display Styles */
        .location-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        @keyframes gentle-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .location-name {
            font-size: clamp(1.4rem, 4vw, 1.8rem); /* More responsive sizing */
            font-weight: 700;
            color: #000000;
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Handle very long city names */
            max-width: 250px; /* Limit width for better mobile experience */
        }

        .location-country {
            font-size: clamp(0.9rem, 3vw, 1.1rem); /* Responsive sizing */
                color: #ffcc00; /* Changed to a gold color */
            font-weight: 500;
            margin: 0;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Handle long country names */
            max-width: 280px; /* Limit width for better mobile experience */
            text-align: center; /* Center align country name */
        }

        .live-time-label {
            color: #ef4444;
                font-weight: 900; /* Increased font weight for emphasis */
            font-size: 1.05em;
            text-shadow: 0 1px 2px rgba(239, 68, 68, 0.3);
            animation: live-pulse 2s ease-in-out infinite;
        }

        @keyframes live-pulse {
            0%, 100% { 
                color: #ef4444;
                text-shadow: 0 1px 2px rgba(239, 68, 68, 0.3);
            }
            50% { 
                color: #dc2626;
                text-shadow: 0 2px 4px rgba(239, 68, 68, 0.5);
            }
        }

        /* Dark mode support for location display */
        @media (prefers-color-scheme: dark) {
            .location-name {
                color: #000000;
            }
            
            .location-country {
                color: #000000;
            }
            
            .live-time-label {
                color: #f87171;
                text-shadow: 0 1px 2px rgba(248, 113, 113, 0.4);
            }
            
            @keyframes live-pulse {
                0%, 100% { 
                    color: #f87171;
                    text-shadow: 0 1px 2px rgba(248, 113, 113, 0.4);
                }
                50% { 
                    color: #ef4444;
                    text-shadow: 0 2px 4px rgba(248, 113, 113, 0.6);
                }
            }
        }
        
        /* Search Section Bright Styling */
        .search-container {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(255, 107, 107, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .search-input-wrapper {
            position: relative;
            margin-bottom: 16px;
        }
        
        .city-search-input {
            width: 100%;
            padding: 16px 50px 16px 20px;
            border: 3px solid #ffffff;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.95);
            color: #2d3748;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .city-search-input:focus {
            outline: none;
            border-color: #f093fb;
            box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.3), 0 8px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .city-search-input::placeholder {
            color: #718096;
            font-weight: 500;
        }
        
        .search-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            color: #ff6b6b;
        }
        
        /* Search Results Styling */
        .search-results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #ff6b6b;
        }
        
        .results-header h5 {
            margin: 0;
            color: #2d3748;
            font-weight: 700;
            font-size: 16px;
        }
        
        .results-count {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .search-result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            border-color: #ff6b6b;
            background: rgba(255, 255, 255, 1);
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }
        
        .city-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .city-flag {
            font-size: 24px;
        }
        
        .city-details {
            display: flex;
            flex-direction: column;
        }
        
        .city-name {
            font-weight: 600;
            color: #2d3748;
            margin: 0;
        }
        
        .city-country {
            font-size: 12px;
            color: #718096;
            margin: 0;
        }
        
        .add-to-favorites-btn {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
            flex-shrink: 0;
        }
        
        .add-to-favorites-btn:hover {
            background: linear-gradient(45deg, #059669, #10b981);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
        }

        .add-to-favorites-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        /* Search Result Card Styling */
        .search-result-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            cursor: default;
        }

        .search-result-card .location-info {
            flex: 1;
            cursor: pointer;
            border-radius: 8px;
            padding: 8px;
            transition: all 0.2s ease;
        }

        .search-result-card .location-info:hover {
            background: rgba(103, 126, 234, 0.1);
        }

        /* Mobile Optimizations for Search Results */
        @media (max-width: 768px) {
            .search-result-card {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .search-result-card .location-info {
                order: -1;
                text-align: center;
                padding: 12px;
            }

            .add-to-favorites-btn {
                width: 100%;
                padding: 12px 16px;
                font-size: 14px;
                border-radius: 12px;
            }

            .search-result-card .location-flag {
                font-size: 24px;
                align-self: center;
            }
        }

        @media (min-width: 769px) {
            .search-result-card {
                flex-direction: row;
            }

            .search-result-card .location-flag {
                font-size: 20px;
            }
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-style: italic;
        }

        /* Popular Cities Section Styles */
        .popular-section {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(80, 200, 120, 0.1) 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-height: 500px;
            overflow-y: auto;
        }

        .popular-section::-webkit-scrollbar {
            width: 8px;
        }

        .popular-section::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .popular-section::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a90e2, #50c878);
            border-radius: 10px;
        }

        .popular-section::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #357abd, #3da05e);
        }

        .popular-cities-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 20px;
            padding: 10px 5px;
        }

        .continent-section {
            margin-bottom: 25px;
        }

        .continent-section:last-child {
            margin-bottom: 0;
        }

        .continent-title {
            color: #2d3748;
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 18px 0;
            font-family: 'Rajdhani', sans-serif;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        /* Enhanced City Cards Grid with Better Spacing */
        .cities-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin: 16px 0;
        }

        /* Enhanced Mobile Responsive Design for Popular Cities */
        @media (max-width: 480px) {
            .popular-section {
                padding: clamp(12px, 4vw, 20px);
                max-height: 70vh;
                max-height: 70dvh;
                margin: clamp(10px, 3vw, 20px) 0;
                border-radius: clamp(12px, 3vw, 20px);
            }
            
            .section-title {
                font-size: clamp(16px, 5vw, 20px);
                margin-bottom: clamp(12px, 3vw, 18px);
            }
            
            .cities-cards-grid {
                grid-template-columns: 1fr;
                gap: clamp(8px, 2vw, 12px);
            }
            
            .continent-section {
                margin-bottom: clamp(15px, 4vw, 20px);
            }
            
            .continent-title {
                font-size: clamp(14px, 4vw, 18px);
                margin-bottom: clamp(10px, 3vw, 15px);
                padding-bottom: clamp(4px, 1vw, 8px);
            }
            
            .popular-cities-grid {
                gap: clamp(15px, 4vw, 20px);
                padding: clamp(5px, 2vw, 10px) clamp(2px, 1vw, 5px);
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .popular-section {
                padding: clamp(16px, 4vw, 24px);
                max-height: 60vh;
                max-height: 60dvh;
            }
            
            .cities-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                gap: clamp(12px, 3vw, 16px);
            }
            
            .continent-section {
                margin-bottom: clamp(18px, 4vw, 22px);
            }
            
            .continent-title {
                font-size: clamp(16px, 4vw, 19px);
                margin-bottom: clamp(12px, 3vw, 16px);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .popular-section {
                padding: clamp(20px, 3vw, 28px);
                max-height: 500px;
            }
            
            .cities-cards-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: clamp(16px, 2vw, 20px);
            }
        }

        /* Favorite Clocks Section Styles */
        .favorite-clocks-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(168, 85, 247, 0.05) 100%);
            border-radius: 24px;
            padding: 32px;
            margin: 40px 0;
            border: 1px solid rgba(99, 102, 241, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .section-header .section-title {
            font-size: 28px;
            font-weight: 800;
            color: #1e293b;
            margin: 0;
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, #6366f1, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .section-header .section-subtitle {
            font-size: 16px;
            color: #64748b;
            margin: 4px 0 0 0;
            font-weight: 500;
        }

        .manage-favorites-btn {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .manage-favorites-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }

        .btn-icon {
            font-size: 16px;
        }

        /* Favorite Clocks Grid */
        .favorite-clocks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 20px;
        }

        /* Individual Favorite Clock Card */
        .favorite-clock-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 20px;
            padding: 24px;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .favorite-clock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border-color: rgba(99, 102, 241, 0.2);
        }

        .favorite-clock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .favorite-city-info {
            display: flex;
            flex-direction: column;
        }

        .favorite-city-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            font-family: 'Rajdhani', sans-serif;
        }

        .favorite-city-country {
            font-size: 13px;
            color: #64748b;
            margin: 2px 0 0 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .favorite-city-flag {
            font-size: 18px;
        }

        .remove-favorite-btn {
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #dc2626;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .remove-favorite-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        .favorite-clock-time {
            font-size: 32px;
            font-weight: 200;
            color: #1a1a1a;
            margin: 12px 0 8px 0;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            letter-spacing: 1px;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .favorite-clock-date {
            font-size: 14px;
            color: #64748b;
            margin: 0 0 12px 0;
            font-weight: 500;
        }

        .favorite-timezone-info {
            font-size: 12px;
            color: #94a3b8;
            background: rgba(99, 102, 241, 0.05);
            padding: 6px 12px;
            border-radius: 12px;
            display: inline-block;
            font-weight: 500;
        }

        /* Enhanced Mobile Responsive Design for Favorite Clocks */
        @media (max-width: 480px) {
            .favorite-clocks-section {
                padding: clamp(16px, 5vw, 24px) clamp(12px, 4vw, 20px);
                margin: clamp(20px, 6vw, 30px) 0;
                border-radius: clamp(16px, 4vw, 24px);
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: clamp(8px, 3vw, 12px);
                margin-bottom: clamp(20px, 6vw, 28px);
            }

            .section-header .section-title {
                font-size: clamp(20px, 6vw, 24px);
                line-height: 1.2;
            }
            
            .section-header .section-subtitle {
                font-size: clamp(13px, 4vw, 16px);
            }

            .manage-favorites-btn {
                padding: clamp(10px, 3vw, 12px) clamp(16px, 5vw, 24px);
                font-size: clamp(12px, 3.5vw, 14px);
                border-radius: clamp(12px, 3vw, 16px);
                min-height: 44px;
                width: 100%;
                max-width: 240px;
            }

            .favorite-clocks-grid {
                grid-template-columns: 1fr;
                gap: clamp(16px, 5vw, 20px);
            }

            .favorite-clock-card {
                padding: clamp(16px, 5vw, 20px);
                border-radius: clamp(16px, 4vw, 20px);
            }

            .favorite-clock-time {
                font-size: clamp(24px, 8vw, 28px);
                margin: clamp(10px, 3vw, 12px) 0 clamp(6px, 2vw, 8px) 0;
                font-weight: 200;
                font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
                letter-spacing: 1px;
                line-height: 1;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .favorite-clock-date {
                font-size: clamp(12px, 3.5vw, 14px);
                margin: 0 0 clamp(10px, 3vw, 12px) 0;
            }
            
            .favorite-city-name {
                font-size: clamp(16px, 4.5vw, 18px);
            }
            
            .favorite-city-country {
                font-size: clamp(11px, 3vw, 13px);
            }
            
            .remove-favorite-btn {
                width: clamp(28px, 8vw, 32px);
                height: clamp(28px, 8vw, 32px);
                font-size: clamp(14px, 4vw, 16px);
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .favorite-clocks-section {
                padding: clamp(20px, 4vw, 28px);
                margin: clamp(25px, 5vw, 35px) 0;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: clamp(10px, 3vw, 14px);
            }

            .section-header .section-title {
                font-size: clamp(22px, 5vw, 26px);
            }

            .favorite-clocks-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: clamp(18px, 4vw, 22px);
            }

            .favorite-clock-card {
                padding: clamp(18px, 4vw, 22px);
            }

            .favorite-clock-time {
                font-size: clamp(26px, 6vw, 30px);
                font-weight: 200;
                font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
                letter-spacing: 1px;
                line-height: 1;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
        }
        
        @media (min-width: 769px) and (max-width: 1024px) {
            .favorite-clocks-section {
                padding: clamp(24px, 3vw, 32px);
                margin: clamp(30px, 4vw, 40px) 0;
            }

            .favorite-clocks-grid {
                grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
                gap: clamp(20px, 3vw, 24px);
            }
        }
        
        /* Additional Mobile Optimizations */
        @media (max-width: 768px) {
            /* Quick Actions Mobile Optimization */
            .quick-actions {
                margin: clamp(15px, 4vw, 25px) 0;
            }
            
            .quick-action-btn {
                padding: clamp(12px, 4vw, 16px) clamp(20px, 6vw, 32px);
                font-size: clamp(14px, 4vw, 16px);
                border-radius: clamp(12px, 3vw, 16px);
                min-height: 48px;
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
                display: block;
            }
            
            .action-icon {
                font-size: clamp(16px, 5vw, 20px);
            }
            
            .action-text {
                font-size: clamp(13px, 4vw, 15px);
            }
            
            /* Search Results Mobile Optimization */
            .search-results {
                border-radius: clamp(10px, 3vw, 12px);
                padding: clamp(12px, 4vw, 16px);
                margin-top: clamp(10px, 3vw, 15px);
            }
            
            .search-result-item {
                padding: clamp(10px, 3vw, 12px);
                margin: clamp(6px, 2vw, 8px) 0;
                border-radius: clamp(8px, 2vw, 10px);
                min-height: 44px;
            }
            
            .city-info {
                gap: clamp(8px, 3vw, 12px);
            }
            
            .add-to-favorites-btn {
                padding: clamp(6px, 2vw, 8px) clamp(12px, 4vw, 16px);
                font-size: clamp(10px, 3vw, 12px);
                border-radius: clamp(16px, 4vw, 20px);
                min-height: 36px;
            }
            
            /* No Results Mobile Styling */
            .no-results {
                padding: clamp(15px, 5vw, 20px);
                font-size: clamp(13px, 4vw, 15px);
            }
        }
        
        /* PWA and Mobile-Specific Enhancements */
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        }
        
        .install-prompt-btn {
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
        }
        
        .install-prompt-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6) !important;
        }
        
        /* Mobile device specific optimizations */
        .mobile-device {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .mobile-device input, .mobile-device textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .touch-device button:hover {
            opacity: 0.8;
        }
        
        .ios-device {
            -webkit-overflow-scrolling: touch;
        }
        
        .android-device {
            overscroll-behavior: contain;
        }
        
        .small-screen .main-time {
            font-size: clamp(2rem, 10vw, 3.5rem) !important;
            letter-spacing: clamp(0.5px, 0.3vw, 2px) !important;
        }
        
        .small-screen .location-name {
            font-size: clamp(1rem, 4vw, 1.4rem) !important;
        }
        
        .small-screen .location-country {
            font-size: clamp(0.8rem, 3vw, 1rem) !important;
        }
        
        /* Accessibility improvements for mobile */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .city-card {
                border: 2px solid #000000;
            }
            
            .location-name, .location-country {
                color: #000000 !important;
                text-shadow: none;
            }
        }
        
        /* Dark mode mobile optimizations */
        @media (prefers-color-scheme: dark) and (max-width: 768px) {
            .city-card {
                background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
                border-color: #4a5568;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            
            .main-content {
                background: #0f172a;
            }
            
            .location-picker-modal {
                background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                color: #f1f5f9;
            }
            
            .city-search-input {
                background: rgba(30, 41, 59, 0.95);
                color: #f1f5f9;
                border-color: #475569;
            }
            
            .city-search-input::placeholder {
                color: #94a3b8;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <!-- Primary Time Display - Large and Prominent with Switch Capability -->
        <div class="hero-time-section">
            <div class="location-header">
                <button class="switch-location-btn" id="switchLocationBtn" onclick="toggleLocationPicker()">
                    <span class="switch-icon" style="margin-right: 8px;">
                        <svg width="16" height="16" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="switchClockGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#f8fafc;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#e2e8f0;stop-opacity:1" />
                                </linearGradient>
                                <linearGradient id="switchHandsGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#4299e1;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#667eea;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle cx="22" cy="22" r="18" 
                                    fill="url(#switchClockGradient)" 
                                    stroke="#667eea" 
                                    stroke-width="1.5"/>
                            <g stroke="#718096" stroke-width="1" opacity="0.6">
                                <line x1="22" y1="6" x2="22" y2="9"/>
                                <line x1="38" y1="22" x2="38" y2="22"/>
                                <line x1="22" y1="38" x2="22" y2="35"/>
                                <line x1="6" y1="22" x2="9" y2="22"/>
                            </g>
                            <g stroke="url(#switchHandsGradient)" stroke-width="1.5" stroke-linecap="round">
                                <line x1="22" y1="22" x2="17" y2="16"/>
                                <line x1="22" y1="22" x2="28" y2="14"/>
                            </g>
                            <circle cx="22" cy="22" r="1.5" fill="#667eea"/>
                        </svg>
                    </span>
                    Change Location
                </button>
            </div>
            <div class="giant-clock-display" id="giantClockDisplay">
                <div class="clock-location-info" id="clockLocationInfo">
                    <div class="location-header">
                        <div class="location-name-row">
                            <span class="location-flag" id="locationFlag" data-country-code="WORLD" title="World Flag">🌍</span>
                            <span class="location-name" id="locationName">Local Time</span>
                        </div>
                        <div class="location-country" id="locationCountry">Your Location</div>
                    </div>
                </div>
                <div class="main-time" id="primaryTime">00:00:00</div>
                <div class="main-date" id="primaryDate">Loading...</div>
                <div class="sun-times" id="sunTimes">
                    <span class="sun-icon">☀️</span>
                    <span class="sun-info" id="sunInfo">🌅 06:30 🌇 18:45 (12h 15m)</span>
                </div>
            </div>
        </div>

        <!-- Favorite Clocks Section -->
        <div class="favorite-clocks-section" id="favoriteClockSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">⭐ My Favorite Clocks</h2>
                <p class="section-subtitle">Keep track of multiple time zones at once</p>
                <button class="manage-favorites-btn" onclick="toggleLocationPicker()">
                    <span class="btn-icon">➕</span>
                    Add More Cities
                </button>
            </div>
            <div class="favorite-clocks-grid" id="favoriteClockGrid">
                <!-- Favorite clocks will be dynamically added here -->
            </div>
        </div>

        <!-- Location Picker Modal -->
        <div class="location-picker-overlay" id="locationPickerOverlay">
            <div class="location-picker-modal">
                <!-- Modal Header with Back Button -->
                <div class="modal-header">
                    <button class="modal-back-btn" onclick="closeLocationModal()" aria-label="Back">
                        <span>✓</span>
                    </button>
                    <h2 class="modal-header-title">Select Location</h2>
                </div>

                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-input-container">
                        <div class="search-icon">🔍</div>
                        <input 
                            type="text" 
                            id="citySearchInput" 
                            class="search-input"
                            placeholder="Search for a city"
                            autocomplete="off"
                            oninput="handleSearchInput(this.value)"
                            aria-label="Search for cities">
                        <button class="search-clear-btn" onclick="clearSearch()" aria-label="Clear search">
                            ×
                        </button>
                    </div>
                    
                    <button class="current-location-btn" onclick="useCurrentLocation()" id="currentLocationBtn">
                        <span class="gps-icon">📍</span>
                        <span class="btn-text">Use Current Location</span>
                        <div class="loading-spinner"></div>
                    </button>
                </div>

                <!-- Selected Location Display -->
                <div class="selected-location" id="selectedLocationDisplay" style="display: none;">
                    <span class="selected-location-flag" id="selectedFlag">🌍</span>
                    <div class="selected-location-info">
                        <div class="selected-location-name" id="selectedName">Selected City</div>
                        <div class="selected-location-country" id="selectedCountry">Country</div>
                    </div>
                    <span class="selected-location-check">✓</span>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Search Results -->
                    <div class="search-results" id="searchResults" style="display: none;">
                        <div class="search-results-header" id="searchResultsHeader">
                            Search Results
                        </div>
                        <div class="search-results-list" id="searchResultsList">
                            <!-- Dynamic search results will go here -->
                        </div>
                    </div>

                    <!-- Popular Cities Sections -->
                    <div class="popular-locations">
                        <!-- North America -->
                        <div class="section-header">
                            <h3 class="section-title">🌍 North America</h3>
                        </div>
                        <div class="location-section">
                            <div class="location-grid">
                                <div class="location-card" >
                                    <span class="location-flag">🇺🇸</span>
                                    <div class="location-info">
                                        <div class="location-name">New York</div>
                                        <div class="location-country">United States</div>
                                    </div>
                                    <div class="location-time" id="time-newyork">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇺🇸</span>
                                    <div class="location-info">
                                        <div class="location-name">Los Angeles</div>
                                        <div class="location-country">United States</div>
                                    </div>
                                    <div class="location-time" id="time-losangeles">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇺🇸</span>
                                    <div class="location-info">
                                        <div class="location-name">Chicago</div>
                                        <div class="location-country">United States</div>
                                    </div>
                                    <div class="location-time" id="time-chicago">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇨🇦</span>
                                    <div class="location-info">
                                        <div class="location-name">Toronto</div>
                                        <div class="location-country">Canada</div>
                                    </div>
                                    <div class="location-time" id="time-toronto">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇨🇦</span>
                                    <div class="location-info">
                                        <div class="location-name">Vancouver</div>
                                        <div class="location-country">Canada</div>
                                    </div>
                                    <div class="location-time" id="time-vancouver">--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Europe -->
                        <div class="section-header">
                            <h3 class="section-title">🌍 Europe</h3>
                        </div>
                        <div class="location-section">
                            <div class="location-grid">
                                <div class="location-card" >
                                    <span class="location-flag">🇬🇧</span>
                                    <div class="location-info">
                                        <div class="location-name">London</div>
                                        <div class="location-country">United Kingdom</div>
                                    </div>
                                    <div class="location-time" id="time-london">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇫🇷</span>
                                    <div class="location-info">
                                        <div class="location-name">Paris</div>
                                        <div class="location-country">France</div>
                                    </div>
                                    <div class="location-time" id="time-paris">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇩🇪</span>
                                    <div class="location-info">
                                        <div class="location-name">Berlin</div>
                                        <div class="location-country">Germany</div>
                                    </div>
                                    <div class="location-time" id="time-berlin">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇮🇹</span>
                                    <div class="location-info">
                                        <div class="location-name">Rome</div>
                                        <div class="location-country">Italy</div>
                                    </div>
                                    <div class="location-time" id="time-rome">--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Asia -->
                        <div class="section-header">
                            <h3 class="section-title">🌍 Asia</h3>
                        </div>
                        <div class="location-section">
                            <div class="location-grid">
                                <div class="location-card" >
                                    <span class="location-flag">🇯🇵</span>
                                    <div class="location-info">
                                        <div class="location-name">Tokyo</div>
                                        <div class="location-country">Japan</div>
                                    </div>
                                    <div class="location-time" id="time-tokyo">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇨🇳</span>
                                    <div class="location-info">
                                        <div class="location-name">Shanghai</div>
                                        <div class="location-country">China</div>
                                    </div>
                                    <div class="location-time" id="time-shanghai">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇦🇪</span>
                                    <div class="location-info">
                                        <div class="location-name">Dubai</div>
                                        <div class="location-country">UAE</div>
                                    </div>
                                    <div class="location-time" id="time-dubai">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇸🇬</span>
                                    <div class="location-info">
                                        <div class="location-name">Singapore</div>
                                        <div class="location-country">Singapore</div>
                                    </div>
                                    <div class="location-time" id="time-singapore">--:--</div>
                                </div>
                            </div>
                        </div>

                        <!-- Oceania -->
                        <div class="section-header">
                            <h3 class="section-title">🌍 Oceania</h3>
                        </div>
                        <div class="location-section">
                            <div class="location-grid">
                                <div class="location-card" >
                                    <span class="location-flag">🇦🇺</span>
                                    <div class="location-info">
                                        <div class="location-name">Sydney</div>
                                        <div class="location-country">Australia</div>
                                    </div>
                                    <div class="location-time" id="time-sydney">--:--</div>
                                </div>
                                
                                <div class="location-card" >
                                    <span class="location-flag">🇳🇿</span>
                                    <div class="location-info">
                                        <div class="location-name">Auckland</div>
                                        <div class="location-country">New Zealand</div>
                                    </div>
                                    <div class="location-time" id="time-auckland">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
                    <div class="popular-section">
                        <h4 class="section-title">🌍 Popular Cities Worldwide</h4>
                        <div class="popular-cities-grid" id="popularCitiesGrid">
                            
                            <!-- North America -->
                            <div class="continent-section">
                                <h5 class="continent-title">🇺🇸 North America</h5>
                                <div class="cities-cards-grid">
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇺🇸</span>
                                            <span class="city-time" id="time-newyork">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">New York</h6>
                                            <p class="city-country">United States</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">EST/EDT</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'New York', 'America/New_York', '🌍', 'United States')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('New York', 'America/New_York', '🇺🇸', 'United States')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇺🇸</span>
                                            <span class="city-time" id="time-losangeles">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Los Angeles</h6>
                                            <p class="city-country">United States</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">PST/PDT</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Los Angeles', 'America/Los_Angeles', '🌍', 'United States')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Los Angeles', 'America/Los_Angeles', '🇺🇸', 'United States')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇨🇦</span>
                                            <span class="city-time" id="time-toronto">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Toronto</h6>
                                            <p class="city-country">Canada</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">EST/EDT</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Toronto', 'America/Toronto', '🌍', 'Canada')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Toronto', 'America/Toronto', '🇨🇦', 'Canada')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Europe -->
                            <div class="continent-section">
                                <h5 class="continent-title">🇪🇺 Europe</h5>
                                <div class="cities-cards-grid">
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇬🇧</span>
                                            <span class="city-time" id="time-london">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">London</h6>
                                            <p class="city-country">United Kingdom</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">GMT/BST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'London', 'Europe/London', '🌍', 'United Kingdom')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('London', 'Europe/London', '🇬🇧', 'United Kingdom')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇫🇷</span>
                                            <span class="city-time" id="time-paris">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Paris</h6>
                                            <p class="city-country">France</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">CET/CEST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Paris', 'Europe/Paris', '🌍', 'France')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Paris', 'Europe/Paris', '🇫🇷', 'France')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇩🇪</span>
                                            <span class="city-time" id="time-berlin">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Berlin</h6>
                                            <p class="city-country">Germany</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">CET/CEST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Berlin', 'Europe/Berlin', '🌍', 'Germany')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Berlin', 'Europe/Berlin', '🇩🇪', 'Germany')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇮🇹</span>
                                            <span class="city-time" id="time-rome">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Rome</h6>
                                            <p class="city-country">Italy</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">CET/CEST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Rome', 'Europe/Rome', '🌍', 'Italy')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Rome', 'Europe/Rome', '🇮🇹', 'Italy')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Asia -->
                            <div class="continent-section">
                                <h5 class="continent-title">🇦🇸 Asia</h5>
                                <div class="cities-cards-grid">
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇯🇵</span>
                                            <span class="city-time" id="time-tokyo">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Tokyo</h6>
                                            <p class="city-country">Japan</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">JST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Tokyo', 'Asia/Tokyo', '🌍', 'Japan')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Tokyo', 'Asia/Tokyo', '🇯🇵', 'Japan')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇨🇳</span>
                                            <span class="city-time" id="time-shanghai">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Shanghai</h6>
                                            <p class="city-country">China</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">CST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Shanghai', 'Asia/Shanghai', '🌍', 'China')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Shanghai', 'Asia/Shanghai', '🇨🇳', 'China')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇦🇪</span>
                                            <span class="city-time" id="time-dubai">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Dubai</h6>
                                            <p class="city-country">UAE</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">GST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Dubai', 'Asia/Dubai', '🌍', 'UAE')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Dubai', 'Asia/Dubai', '🇦🇪', 'UAE')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Oceania -->
                            <div class="continent-section">
                                <h5 class="continent-title">🇦🇺 Oceania</h5>
                                <div class="cities-cards-grid">
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇦🇺</span>
                                            <span class="city-time" id="time-sydney">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Sydney</h6>
                                            <p class="city-country">Australia</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">AEDT/AEST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Sydney', 'Australia/Sydney', '🌍', 'Australia')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Sydney', 'Australia/Sydney', '🇦🇺', 'Australia')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="city-card">
                                        <div class="city-card-header">
                                            <span class="city-flag">🇳🇿</span>
                                            <span class="city-time" id="time-auckland">--:--</span>
                                        </div>
                                        <div class="city-card-body">
                                            <h6 class="city-name">Auckland</h6>
                                            <p class="city-country">New Zealand</p>
                                        </div>
                                        <div class="city-card-footer">
                                            <small class="timezone-info">NZDT/NZST</small>
                                            <div class="city-card-actions">
                                                <button class="quick-favorite-btn" 
                                                        onclick="addCityToFavorites(event, 'Auckland', 'Pacific/Auckland', '🌍', 'New Zealand')"
                                                        title="Add to favorites">
                                                    ⭐
                                                </button>
                                                <button class="make-primary-btn" 
                                                        onclick="selectLocation('Auckland', 'Pacific/Auckland', '🇳🇿', 'New Zealand')"
                                                        title="Make primary clock">
                                                    🌍
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Subtle Footer -->
    <footer class="app-footer">
        Made with <span class="heart">❤️</span> by hashtk.com © 2025
    </footer>

    <!-- Core JavaScript -->
    <script>
        // Global cities database for search (Comprehensive Worldwide Coverage)
        const globalCitiesDatabase = [
            // North America - United States (Expanded)
            { name: 'New York', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'Los Angeles', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'Chicago', timezone: 'America/Chicago', flag: '🌍', country: 'United States' },
            { name: 'Miami', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'San Francisco', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'Boston', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'Washington DC', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'Atlanta', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'Dallas', timezone: 'America/Chicago', flag: '🌍', country: 'United States' },
            { name: 'Houston', timezone: 'America/Chicago', flag: '🌍', country: 'United States' },
            { name: 'Seattle', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'Las Vegas', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'Phoenix', timezone: 'America/Phoenix', flag: '🌍', country: 'United States' },
            { name: 'Denver', timezone: 'America/Denver', flag: '🌍', country: 'United States' },
            
            // Additional US Cities
            { name: 'Philadelphia', timezone: 'America/New_York', flag: '🌍', country: 'United States' },
            { name: 'San Antonio', timezone: 'America/Chicago', flag: '🌍', country: 'United States' },
            { name: 'San Diego', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'San Jose', timezone: 'America/Los_Angeles', flag: '🌍', country: 'United States' },
            { name: 'Austin', timezone: 'America/Chicago', flag: '🌍', country: 'United States' },
            { name: 'New York', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Los Angeles', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Chicago', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Miami', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'San Francisco', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Boston', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Washington DC', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Atlanta', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Dallas', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Houston', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Seattle', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Las Vegas', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Phoenix', timezone: 'America/Phoenix', flag: '🇺🇸', country: 'United States' },
            { name: 'Denver', timezone: 'America/Denver', flag: '🇺🇸', country: 'United States' },
            { name: 'Philadelphia', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'San Antonio', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'San Diego', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'San Jose', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Austin', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Austin', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Jacksonville', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Fort Worth', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Columbus', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Charlotte', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Indianapolis', timezone: 'America/Indiana/Indianapolis', flag: '🇺🇸', country: 'United States' },
            { name: 'Nashville', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Detroit', timezone: 'America/Detroit', flag: '🇺🇸', country: 'United States' },
            { name: 'Memphis', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Portland', timezone: 'America/Los_Angeles', flag: '🇺🇸', country: 'United States' },
            { name: 'Oklahoma City', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Louisville', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Baltimore', timezone: 'America/New_York', flag: '🇺🇸', country: 'United States' },
            { name: 'Milwaukee', timezone: 'America/Chicago', flag: '🇺🇸', country: 'United States' },
            { name: 'Albuquerque', timezone: 'America/Denver', flag: '🇺🇸', country: 'United States' },
            { name: 'Tucson', timezone: 'America/Phoenix', flag: '🇺🇸', country: 'United States' },
            { name: 'Hamilton', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Brampton', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Surrey', timezone: 'America/Vancouver', flag: '🇨🇦', country: 'Canada' },
            { name: 'Laval', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Halifax', timezone: 'America/Halifax', flag: '🇨🇦', country: 'Canada' },
            { name: 'London', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Markham', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Vaughan', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Gatineau', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Saskatoon', timezone: 'America/Regina', flag: '🇨🇦', country: 'Canada' },
            { name: 'Longueuil', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Burnaby', timezone: 'America/Vancouver', flag: '🇨🇦', country: 'Canada' },
            { name: 'Regina', timezone: 'America/Regina', flag: '🇨🇦', country: 'Canada' },
            { name: 'Richmond', timezone: 'America/Vancouver', flag: '🇨🇦', country: 'Canada' },
            { name: 'Richmond Hill', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Oakville', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Burlington', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Greater Sudbury', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Sherbrooke', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Oshawa', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            { name: 'Saguenay', timezone: 'America/Toronto', flag: '🇨🇦', country: 'Canada' },
            
            // North America - Mexico (Expanded)
            { name: 'Mexico City', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Guadalajara', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Cancun', timezone: 'America/Cancun', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Monterrey', timezone: 'America/Monterrey', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Puebla', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Tijuana', timezone: 'America/Tijuana', flag: '🇲🇽', country: 'Mexico' },
            { name: 'León', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Juárez', timezone: 'America/Ojinaga', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Torreón', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Querétaro', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'San Luis Potosí', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Mérida', timezone: 'America/Merida', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Mexicali', timezone: 'America/Tijuana', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Aguascalientes', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Acapulco', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Cuernavaca', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Saltillo', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Xalapa', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Tampico', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            { name: 'Toluca', timezone: 'America/Mexico_City', flag: '🇲🇽', country: 'Mexico' },
            
            // Europe - United Kingdom (Expanded)
            { name: 'London', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Manchester', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Edinburgh', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Birmingham', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Liverpool', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Leeds', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Glasgow', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Sheffield', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Bradford', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Newcastle', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Leicester', timezone: 'Europe/London', flag: '🇬🇧', country: 'United Kingdom' },
            { name: 'Nottingham', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Bristol', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Cardiff', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Belfast', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Hull', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Plymouth', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Stoke-on-Trent', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Wolverhampton', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Derby', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Swansea', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Southampton', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Salford', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Aberdeen', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Westminster', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Portsmouth', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'York', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Peterborough', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Dundee', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            { name: 'Lancaster', timezone: 'Europe/London', flag: '🌍', country: 'United Kingdom' },
            
            // Europe - France
            { name: 'Paris', timezone: 'Europe/Paris', flag: '🌍', country: 'France' },
            { name: 'Marseille', timezone: 'Europe/Paris', flag: '🌍', country: 'France' },
            { name: 'Lyon', timezone: 'Europe/Paris', flag: '🌍', country: 'France' },
            { name: 'Nice', timezone: 'Europe/Paris', flag: '🌍', country: 'France' },
            
            // Europe - Germany
            { name: 'Berlin', timezone: 'Europe/Berlin', flag: '🌍', country: 'Germany' },
            { name: 'Munich', timezone: 'Europe/Berlin', flag: '🌍', country: 'Germany' },
            { name: 'Hamburg', timezone: 'Europe/Berlin', flag: '🌍', country: 'Germany' },
            { name: 'Frankfurt', timezone: 'Europe/Berlin', flag: '🌍', country: 'Germany' },
            
            // Europe - Other Countries
            { name: 'Rome', timezone: 'Europe/Rome', flag: '🌍', country: 'Italy' },
            { name: 'Milan', timezone: 'Europe/Rome', flag: '🌍', country: 'Italy' },
            { name: 'Madrid', timezone: 'Europe/Madrid', flag: '🌍', country: 'Spain' },
            { name: 'Barcelona', timezone: 'Europe/Madrid', flag: '🌍', country: 'Spain' },
            { name: 'Amsterdam', timezone: 'Europe/Amsterdam', flag: '🌍', country: 'Netherlands' },
            { name: 'Stockholm', timezone: 'Europe/Stockholm', flag: '🌍', country: 'Sweden' },
            { name: 'Oslo', timezone: 'Europe/Oslo', flag: '🌍', country: 'Norway' },
            { name: 'Copenhagen', timezone: 'Europe/Copenhagen', flag: '🇩🇰', country: 'Denmark' },
            { name: 'Helsinki', timezone: 'Europe/Helsinki', flag: '🇫🇮', country: 'Finland' },
            { name: 'Vienna', timezone: 'Europe/Vienna', flag: '🇦🇹', country: 'Austria' },
            { name: 'Zurich', timezone: 'Europe/Zurich', flag: '🇨🇭', country: 'Switzerland' },
            { name: 'Brussels', timezone: 'Europe/Brussels', flag: '🇧🇪', country: 'Belgium' },
            { name: 'Dublin', timezone: 'Europe/Dublin', flag: '🇮🇪', country: 'Ireland' },
            { name: 'Lisbon', timezone: 'Europe/Lisbon', flag: '🇵🇹', country: 'Portugal' },
            { name: 'Prague', timezone: 'Europe/Prague', flag: '🇨🇿', country: 'Czech Republic' },
            { name: 'Warsaw', timezone: 'Europe/Warsaw', flag: '🇵🇱', country: 'Poland' },
            { name: 'Budapest', timezone: 'Europe/Budapest', flag: '🇭🇺', country: 'Hungary' },
            { name: 'Moscow', timezone: 'Europe/Moscow', flag: '🌍', country: 'Russia' },
            { name: 'Kiev', timezone: 'Europe/Kiev', flag: '🇺🇦', country: 'Ukraine' },
            { name: 'Istanbul', timezone: 'Europe/Istanbul', flag: '🇹🇷', country: 'Turkey' },
            { name: 'Athens', timezone: 'Europe/Athens', flag: '🇬🇷', country: 'Greece' },
            
            // Asia - East Asia
            { name: 'Tokyo', timezone: 'Asia/Tokyo', flag: '🌍', country: 'Japan' },
            { name: 'Osaka', timezone: 'Asia/Tokyo', flag: '🌍', country: 'Japan' },
            { name: 'Kyoto', timezone: 'Asia/Tokyo', flag: '🌍', country: 'Japan' },
            { name: 'Shanghai', timezone: 'Asia/Shanghai', flag: '🌍', country: 'China' },
            { name: 'Beijing', timezone: 'Asia/Shanghai', flag: '🌍', country: 'China' },
            { name: 'Guangzhou', timezone: 'Asia/Shanghai', flag: '🌍', country: 'China' },
            { name: 'Shenzhen', timezone: 'Asia/Shanghai', flag: '🌍', country: 'China' },
            { name: 'Hong Kong', timezone: 'Asia/Hong_Kong', flag: '🇭🇰', country: 'Hong Kong' },
            { name: 'Seoul', timezone: 'Asia/Seoul', flag: '🌍', country: 'South Korea' },
            { name: 'Busan', timezone: 'Asia/Seoul', flag: '🌍', country: 'South Korea' },
            { name: 'Taipei', timezone: 'Asia/Taipei', flag: '🇹🇼', country: 'Taiwan' },
            
            // Asia - Southeast Asia
            { name: 'Singapore', timezone: 'Asia/Singapore', flag: '🌍', country: 'Singapore' },
            { name: 'Bangkok', timezone: 'Asia/Bangkok', flag: '🌍', country: 'Thailand' },
            { name: 'Manila', timezone: 'Asia/Manila', flag: '🇵🇭', country: 'Philippines' },
            { name: 'Jakarta', timezone: 'Asia/Jakarta', flag: '🇮🇩', country: 'Indonesia' },
            { name: 'Kuala Lumpur', timezone: 'Asia/Kuala_Lumpur', flag: '🇲🇾', country: 'Malaysia' },
            { name: 'Ho Chi Minh City', timezone: 'Asia/Ho_Chi_Minh', flag: '🇻🇳', country: 'Vietnam' },
            { name: 'Hanoi', timezone: 'Asia/Ho_Chi_Minh', flag: '🌍', country: 'Vietnam' },
            
            // Asia - South Asia
            { name: 'Mumbai', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Delhi', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Bangalore', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Chennai', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Hyderabad', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Pune', timezone: 'Asia/Kolkata', flag: '🌍', country: 'India' },
            { name: 'Karachi', timezone: 'Asia/Karachi', flag: '🌍', country: 'Pakistan' },
            { name: 'Lahore', timezone: 'Asia/Karachi', flag: '🌍', country: 'Pakistan' },
            { name: 'Dhaka', timezone: 'Asia/Dhaka', flag: '🇧🇩', country: 'Bangladesh' },
            { name: 'Colombo', timezone: 'Asia/Colombo', flag: '🇱🇰', country: 'Sri Lanka' },
            
            // Asia - Middle East
            { name: 'Dubai', timezone: 'Asia/Dubai', flag: '🌍', country: 'UAE' },
            { name: 'Abu Dhabi', timezone: 'Asia/Dubai', flag: '🌍', country: 'UAE' },
            { name: 'Doha', timezone: 'Asia/Qatar', flag: '🇶🇦', country: 'Qatar' },
            { name: 'Kuwait City', timezone: 'Asia/Kuwait', flag: '🇰🇼', country: 'Kuwait' },
            { name: 'Riyadh', timezone: 'Asia/Riyadh', flag: '🇸🇦', country: 'Saudi Arabia' },
            { name: 'Jeddah', timezone: 'Asia/Riyadh', flag: '🇸🇦', country: 'Saudi Arabia' },
            { name: 'Tehran', timezone: 'Asia/Tehran', flag: '🇮🇷', country: 'Iran' },
            { name: 'Baghdad', timezone: 'Asia/Baghdad', flag: '🇮🇶', country: 'Iraq' },
            { name: 'Tel Aviv', timezone: 'Asia/Jerusalem', flag: '🇮🇱', country: 'Israel' },
            { name: 'Jerusalem', timezone: 'Asia/Jerusalem', flag: '🇮🇱', country: 'Israel' },
            
            // Africa
            { name: 'Cairo', timezone: 'Africa/Cairo', flag: '🇪🇬', country: 'Egypt' },
            { name: 'Lagos', timezone: 'Africa/Lagos', flag: '🇳🇬', country: 'Nigeria' },
            { name: 'Cape Town', timezone: 'Africa/Johannesburg', flag: '🌍', country: 'South Africa' },
            { name: 'Johannesburg', timezone: 'Africa/Johannesburg', flag: '🌍', country: 'South Africa' },
            { name: 'Nairobi', timezone: 'Africa/Nairobi', flag: '🇰🇪', country: 'Kenya' },
            { name: 'Casablanca', timezone: 'Africa/Casablanca', flag: '🇲🇦', country: 'Morocco' },
            { name: 'Tunis', timezone: 'Africa/Tunis', flag: '🇹🇳', country: 'Tunisia' },
            { name: 'Algiers', timezone: 'Africa/Algiers', flag: '🇩🇿', country: 'Algeria' },
            { name: 'Accra', timezone: 'Africa/Accra', flag: '🇬🇭', country: 'Ghana' },
            { name: 'Addis Ababa', timezone: 'Africa/Addis_Ababa', flag: '🇪🇹', country: 'Ethiopia' },
            
            // Oceania
            { name: 'Sydney', timezone: 'Australia/Sydney', flag: '🌍', country: 'Australia' },
            { name: 'Melbourne', timezone: 'Australia/Melbourne', flag: '🌍', country: 'Australia' },
            { name: 'Brisbane', timezone: 'Australia/Brisbane', flag: '🌍', country: 'Australia' },
            { name: 'Perth', timezone: 'Australia/Perth', flag: '🌍', country: 'Australia' },
            { name: 'Adelaide', timezone: 'Australia/Adelaide', flag: '🌍', country: 'Australia' },
            { name: 'Auckland', timezone: 'Pacific/Auckland', flag: '🌍', country: 'New Zealand' },
            { name: 'Wellington', timezone: 'Pacific/Auckland', flag: '🌍', country: 'New Zealand' },
            { name: 'Christchurch', timezone: 'Pacific/Auckland', flag: '🇳🇿', country: 'New Zealand' },
            { name: 'Fiji', timezone: 'Pacific/Fiji', flag: '🇫🇯', country: 'Fiji' },
            
            // South America
            { name: 'São Paulo', timezone: 'America/Sao_Paulo', flag: '🌍', country: 'Brazil' },
            { name: 'Rio de Janeiro', timezone: 'America/Sao_Paulo', flag: '🌍', country: 'Brazil' },
            { name: 'Brasília', timezone: 'America/Sao_Paulo', flag: '🌍', country: 'Brazil' },
            { name: 'Salvador', timezone: 'America/Sao_Paulo', flag: '🌍', country: 'Brazil' },
            { name: 'Buenos Aires', timezone: 'America/Argentina/Buenos_Aires', flag: '🌍', country: 'Argentina' },
            { name: 'Córdoba', timezone: 'America/Argentina/Cordoba', flag: '🌍', country: 'Argentina' },
            { name: 'Lima', timezone: 'America/Lima', flag: '🇵🇪', country: 'Peru' },
            { name: 'Santiago', timezone: 'America/Santiago', flag: '🇨🇱', country: 'Chile' },
            { name: 'Bogotá', timezone: 'America/Bogota', flag: '🇨🇴', country: 'Colombia' },
            { name: 'Caracas', timezone: 'America/Caracas', flag: '🇻🇪', country: 'Venezuela' },
            { name: 'Quito', timezone: 'America/Guayaquil', flag: '🇪🇨', country: 'Ecuador' },
            { name: 'La Paz', timezone: 'America/La_Paz', flag: '🇧🇴', country: 'Bolivia' },
            { name: 'Montevideo', timezone: 'America/Montevideo', flag: '🇺🇾', country: 'Uruguay' },
            { name: 'Asunción', timezone: 'America/Asuncion', flag: '🇵🇾', country: 'Paraguay' },
            
            // Central America & Caribbean
            { name: 'Havana', timezone: 'America/Havana', flag: '🇨🇺', country: 'Cuba' },
            { name: 'Kingston', timezone: 'America/Jamaica', flag: '🇯🇲', country: 'Jamaica' },
            { name: 'Santo Domingo', timezone: 'America/Santo_Domingo', flag: '🇩🇴', country: 'Dominican Republic' },
            { name: 'San José', timezone: 'America/Costa_Rica', flag: '🇨🇷', country: 'Costa Rica' },
            { name: 'Panama City', timezone: 'America/Panama', flag: '🇵🇦', country: 'Panama' },
            { name: 'Guatemala City', timezone: 'America/Guatemala', flag: '🇬🇹', country: 'Guatemala' }
        ];

        // Mobile-specific functionality and optimizations
        class MobileOptimizer {
            constructor() {
                this.isMobile = this.detectMobile();
                this.isIOS = this.detectIOS();
                this.isAndroid = this.detectAndroid();
                this.hasTouch = 'ontouchstart' in window;
                this.init();
            }

            detectMobile() {
                return window.innerWidth <= 768 || /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            }

            detectIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }

            detectAndroid() {
                return /Android/i.test(navigator.userAgent);
            }

            init() {
                if (this.isMobile) {
                    this.optimizeForMobile();
                    this.addMobileTouchEvents();
                    this.handleViewportChanges();
                    this.optimizeModalForMobile();
                    this.addSwipeGestures();
                }

                if (this.isIOS) {
                    this.optimizeForIOS();
                }

                if (this.isAndroid) {
                    this.optimizeForAndroid();
                }

                // Handle device orientation changes
                window.addEventListener('orientationchange', () => {
                    setTimeout(() => this.handleOrientationChange(), 100);
                });

                // Handle viewport resize
                window.addEventListener('resize', () => {
                    this.handleViewportChanges();
                });
            }

            optimizeForMobile() {
                // Prevent zoom on double-tap for certain elements
                const preventZoomElements = document.querySelectorAll('.city-card, .search-result-item, .quick-action-btn');
                preventZoomElements.forEach(element => {
                    element.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        e.target.click();
                    });
                });

                // Optimize scroll performance
                document.body.style.webkitOverflowScrolling = 'touch';
                
                // Add mobile-specific classes
                document.body.classList.add('mobile-device');
                
                if (this.hasTouch) {
                    document.body.classList.add('touch-device');
                }
            }

            optimizeForIOS() {
                document.body.classList.add('ios-device');
                
                // Handle iOS keyboard issues
                const inputs = document.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        setTimeout(() => {
                            if (document.activeElement === input) {
                                input.scrollIntoView({ block: 'center', behavior: 'smooth' });
                            }
                        }, 300);
                    });
                });

                // Prevent body scroll when modal is open (iOS specific fix)
                const originalOverflow = document.body.style.overflow;
                window.toggleBodyScroll = (disable) => {
                    if (disable) {
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    } else {
                        document.body.style.overflow = originalOverflow;
                        document.body.style.position = '';
                        document.body.style.width = '';
                    }
                };
            }

            optimizeForAndroid() {
                document.body.classList.add('android-device');
                
                // Android-specific optimizations
                const viewport = document.querySelector('meta[name=viewport]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
            }

            addMobileTouchEvents() {
                // Add haptic feedback for supported devices
                const addHapticFeedback = (element, intensity = 'light') => {
                    element.addEventListener('touchstart', () => {
                        if (navigator.vibrate) {
                            navigator.vibrate(intensity === 'light' ? 10 : 25);
                        }
                    });
                };

                // Add haptic feedback to interactive elements
                document.querySelectorAll('.city-card, .quick-favorite-btn, .quick-action-btn').forEach(element => {
                    addHapticFeedback(element);
                });
            }

            handleViewportChanges() {
                // Update CSS custom properties for dynamic viewport
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
                
                // Handle small screen optimizations
                if (window.innerWidth < 400) {
                    document.body.classList.add('small-screen');
                } else {
                    document.body.classList.remove('small-screen');
                }
            }

            handleOrientationChange() {
                this.handleViewportChanges();
                
                // Force re-layout after orientation change
                const modal = document.getElementById('locationPickerOverlay');
                if (modal && modal.style.display !== 'none') {
                    modal.style.height = '100vh';
                    modal.style.height = '100dvh';
                }
            }

            optimizeModalForMobile() {
                const modal = document.getElementById('locationPickerOverlay');
                if (!modal) return;

                // Improve modal scrolling on mobile
                const modalBody = modal.querySelector('.modal-body');
                if (modalBody) {
                    modalBody.style.webkitOverflowScrolling = 'touch';
                    modalBody.style.overscrollBehavior = 'contain';
                }

                // Add pull-to-close functionality for mobile
                this.addPullToClose(modal);
            }

            addPullToClose(modal) {
                let startY = 0;
                let currentY = 0;
                let isDragging = false;
                
                const modalContent = modal.querySelector('.location-picker-modal');
                if (!modalContent) return;

                modalContent.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                    modalContent.style.transition = 'none';
                });

                modalContent.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    
                    currentY = e.touches[0].clientY;
                    const diff = currentY - startY;
                    
                    if (diff > 0) {
                        modalContent.style.transform = `translateY(${diff}px)`;
                        const opacity = Math.max(0.5, 1 - diff / 300);
                        modal.style.backgroundColor = `rgba(0, 0, 0, ${opacity * 0.5})`;
                    }
                });

                modalContent.addEventListener('touchend', () => {
                    if (!isDragging) return;
                    
                    const diff = currentY - startY;
                    isDragging = false;
                    
                    modalContent.style.transition = 'transform 0.3s ease';
                    
                    if (diff > 100) {
                        // Close modal if pulled down enough
                        if (typeof toggleLocationPicker === 'function') {
                            toggleLocationPicker();
                        }
                    } else {
                        // Snap back
                        modalContent.style.transform = 'translateY(0)';
                        modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                    }
                });
            }

            addSwipeGestures() {
                // Add swipe gestures for better mobile navigation
                let touchStartX = 0;
                let touchStartY = 0;

                document.addEventListener('touchstart', (e) => {
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                }, { passive: true });

                document.addEventListener('touchend', (e) => {
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    
                    const deltaX = touchEndX - touchStartX;
                    const deltaY = touchEndY - touchStartY;
                    
                    // Detect swipe gestures
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                        if (deltaX > 0) {
                            // Swipe right
                            this.handleSwipeRight();
                        } else {
                            // Swipe left
                            this.handleSwipeLeft();
                        }
                    }
                }, { passive: true });
            }

            handleSwipeRight() {
                // Close modal on swipe right if open
                const modal = document.getElementById('locationPickerOverlay');
                if (modal && modal.style.display !== 'none') {
                    if (typeof toggleLocationPicker === 'function') {
                        toggleLocationPicker();
                    }
                }
            }

            handleSwipeLeft() {
                // Open modal on swipe left if closed
                const modal = document.getElementById('locationPickerOverlay');
                if (modal && modal.style.display === 'none') {
                    if (typeof toggleLocationPicker === 'function') {
                        toggleLocationPicker();
                    }
                }
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize mobile optimizer
            window.mobileOptimizer = new MobileOptimizer();
            // Do NOT call startClock() here; main clock is started by startClockUpdates() after location is loaded
            // Set up modal close on backdrop click (only if click is outside modal content)
            const modal = document.getElementById('locationPickerOverlay');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    const modalContent = modal.querySelector('.location-picker-modal');
                    // If click is outside modal content, close modal
                    if (e.target === modal && (!modalContent || !modalContent.contains(e.target))) {
                        toggleLocationPicker();
                    }
                });
            }
            
            // Set up keyboard navigation
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && window.timelyAppState.isModalOpen) {
                    toggleLocationPicker();
                }
            });
            
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to the install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installButton.remove();
                }
            });
            
            document.body.appendChild(installButton);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (installButton.parentNode) {
                    installButton.remove();
                }
            }, 10000);
        });

        // Global state management
        window.timelyAppState = {
            currentLocationData: null,
            clockInterval: null,
            isClockRunning: false,
            isModalOpen: false,
            favoriteClocks: JSON.parse(localStorage.getItem('favoriteClocks') || '[]'),
            favoriteClockIntervals: {}
        };

        // Search functionality
        function searchCities(query) {
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!query || query.trim().length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            const filteredCities = globalCitiesDatabase.filter(city => 
                city.name.toLowerCase().includes(query.toLowerCase()) ||
                city.country.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredCities.length > 0) {
                searchResults.style.display = 'block';
                resultsCount.textContent = `${filteredCities.length} cities found`;
                searchResultsList.innerHTML = filteredCities.map(city => `
                    <div class="search-result-item">
                        <div class="city-info">
                            <span class="city-flag">${city.flag}</span>
                            <div class="city-details">
                                <span class="city-name">${city.name}</span>
                                <span class="city-country">${city.country}</span>
                            </div>
                        </div>
                        <button class="add-to-favorites-btn" 
                                onclick="addToFavorites('${city.name}', '${city.timezone}', '${city.flag}', '${city.country}')"
                                title="Add ${city.name} to favorites">
                            ⭐ Add to Favorites
                        </button>
                    </div>
                `).join('');
            } else {
                searchResults.style.display = 'block';
                resultsCount.textContent = 'No cities found';
                searchResultsList.innerHTML = '<div class="no-results">No cities match your search. Try a different term.</div>';
            }
        }

        // Location Detection
        async function detectMyLocation() {
            const detectBtn = document.querySelector('.detect-btn');
            const originalText = detectBtn.innerHTML;
            
            detectBtn.innerHTML = '<span class="action-icon">⏳</span><span class="action-text">Detecting...</span>';
            detectBtn.disabled = true;
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by this browser');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 600000
                    });
                });
                
                const { latitude, longitude } = position.coords;
                const locationData = await reverseGeocode(latitude, longitude);
                
                if (locationData) {
                    selectLocation(locationData.city, locationData.timezone, locationData.flag, locationData.country);
                    showNotification(`📍 Location detected: ${locationData.city}`, 'success');
                } else {
                    throw new Error('Could not determine your city');
                }
            } catch (error) {
                console.error('Location detection error:', error);
                showNotification('Location detection failed. Please select manually.', 'error');
            } finally {
                detectBtn.innerHTML = originalText;
                detectBtn.disabled = false;
            }
        }

        // Reverse geocoding
        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                if (!response.ok) throw new Error('Geocoding service unavailable');
                
                const data = await response.json();
                const city = data.city || data.locality || data.principalSubdivision;
                const country = data.countryName;
                const countryCode = data.countryCode;
                
                if (!city) throw new Error('City not found');
                
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const flag = getCountryFlag(countryCode);
                
                return { city, country, timezone, flag, coordinates: { lat, lon } };
            } catch (error) {
                console.error('Reverse geocoding failed:', error);
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const parts = timezone.split('/');
                const city = parts[parts.length - 1].replace(/_/g, ' ');
                return { city, country: 'Your Location', timezone, flag: '🌍', coordinates: { lat, lon } };
            }
        }

        // Get country flag
        function getCountryFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) return '🌍';
            const flagMap = {
                // North America
                'US': '🌍', 'CA': '🌍', 'MX': '🌍',
                // Europe
                'GB': '🌍', 'FR': '🌍', 'DE': '🌍', 'IT': '🌍', 'ES': '🌍', 
                'NL': '🌍', 'SE': '🌍', 'NO': '🌍', 'DK': '🇩🇰', 'FI': '🇫🇮',
                'AT': '🇦🇹', 'CH': '🇨🇭', 'BE': '🇧🇪', 'IE': '🇮🇪', 'PT': '🇵🇹',
                'CZ': '🇨🇿', 'PL': '🇵🇱', 'HU': '🇭🇺', 'RU': '🌍', 'UA': '🇺🇦',
                'TR': '🇹🇷', 'GR': '🇬🇷',
                // Asia
                'JP': '🌍', 'CN': '🌍', 'KR': '🌍', 'SG': '🌍', 'HK': '🇭🇰',
                'TW': '🇹🇼', 'IN': '🌍', 'TH': '🌍', 'PH': '🇵🇭', 'ID': '🇮🇩',
                'MY': '🇲🇾', 'VN': '🌍', 'PK': '🌍', 'BD': '🇧🇩', 'LK': '🇱🇰',
                'AE': '🌍', 'QA': '🇶🇦', 'KW': '🇰🇼', 'SA': '🇸🇦', 'IR': '🇮🇷',
                'IQ': '🇮🇶', 'IL': '🇮🇱',
                // Africa
                'EG': '🇪🇬', 'NG': '🇳🇬', 'ZA': '🌍', 'KE': '🇰🇪', 'MA': '🇲🇦',
                'TN': '🇹🇳', 'DZ': '🇩🇿', 'GH': '🇬🇭', 'ET': '🇪🇹',
                // Oceania
                'AU': '🌍', 'NZ': '🌍', 'FJ': '🇫🇯',
                // South America
                'BR': '🌍', 'AR': '🌍', 'PE': '🇵🇪', 'CL': '🇨🇱', 'CO': '🇨🇴',
                'VE': '🇻🇪', 'EC': '🇪🇨', 'BO': '🇧🇴', 'UY': '🇺🇾', 'PY': '🇵🇾',
                // Central America & Caribbean
                'CU': '🇨🇺', 'JM': '🇯🇲', 'DO': '🇩🇴', 'CR': '🇨🇷', 'PA': '🇵🇦', 'GT': '🇬🇹'
            };
            return flagMap[countryCode.toUpperCase()] || '🌍';
        }

        // Get flag based on timezone
        function getTimezoneFlag(timezone) {
            const timezoneToFlag = {
                // North America
                'America/New_York': '🇺🇸', 'America/Chicago': '🇺🇸', 'America/Denver': '🇺🇸', 'America/Los_Angeles': '🇺🇸',
                'America/Phoenix': '🇺🇸', 'America/Anchorage': '🇺🇸', 'Pacific/Honolulu': '🇺🇸',
                'America/Toronto': '🇨🇦', 'America/Vancouver': '🇨🇦', 'America/Edmonton': '🇨🇦', 'America/Halifax': '🇨🇦',
                'America/Mexico_City': '🇲🇽', 'America/Cancun': '🇲🇽', 'America/Tijuana': '🇲🇽',

                // Europe
                'Europe/London': '🇬🇧', 'Europe/Dublin': '🇮🇪', 'Europe/Paris': '🇫🇷', 'Europe/Berlin': '🇩🇪',
                'Europe/Rome': '🇮🇹', 'Europe/Madrid': '🇪🇸', 'Europe/Amsterdam': '🇳🇱', 'Europe/Stockholm': '🇸🇪',
                'Europe/Oslo': '🇳🇴', 'Europe/Copenhagen': '🇩🇰', 'Europe/Helsinki': '🇫🇮', 'Europe/Vienna': '🇦🇹',
                'Europe/Zurich': '🇨🇭', 'Europe/Brussels': '🇧🇪', 'Europe/Lisbon': '🇵🇹', 'Europe/Prague': '🇨🇿',
                'Europe/Warsaw': '🇵🇱', 'Europe/Budapest': '🇭🇺', 'Europe/Moscow': '🇷🇺', 'Europe/Kiev': '🇺🇦',
                'Europe/Istanbul': '🇹🇷', 'Europe/Athens': '🇬🇷',

                // Asia
                'Asia/Tokyo': '🇯🇵', 'Asia/Shanghai': '🇨🇳', 'Asia/Seoul': '🇰🇷', 'Asia/Singapore': '🇸🇬',
                'Asia/Hong_Kong': '🇭🇰', 'Asia/Taipei': '🇹🇼', 'Asia/Kolkata': '🇮🇳', 'Asia/Bangkok': '🇹🇭',
                'Asia/Manila': '🇵🇭', 'Asia/Jakarta': '🇮🇩', 'Asia/Kuala_Lumpur': '🇲🇾', 'Asia/Ho_Chi_Minh': '🇻🇳',
                'Asia/Karachi': '🇵🇰', 'Asia/Dhaka': '🇧🇩', 'Asia/Colombo': '🇱🇰', 'Asia/Dubai': '🇦🇪',
                'Asia/Qatar': '🇶🇦', 'Asia/Kuwait': '🇰🇼', 'Asia/Riyadh': '🇸🇦', 'Asia/Tehran': '🇮🇷',
                'Asia/Baghdad': '🇮🇶', 'Asia/Jerusalem': '🇮🇱',

                // Africa
                'Africa/Cairo': '🇪🇬', 'Africa/Lagos': '🇳🇬', 'Africa/Johannesburg': '🇿🇦', 'Africa/Nairobi': '🇰🇪',
                'Africa/Casablanca': '🇲🇦', 'Africa/Tunis': '🇹🇳', 'Africa/Algiers': '🇩🇿', 'Africa/Accra': '🇬🇭',
                'Africa/Addis_Ababa': '🇪🇹',

                // Oceania
                'Australia/Sydney': '🇦🇺', 'Australia/Melbourne': '🇦🇺', 'Australia/Brisbane': '🇦🇺',
                'Australia/Perth': '🇦🇺', 'Australia/Adelaide': '🇦🇺', 'Pacific/Auckland': '🇳🇿',
                'Pacific/Fiji': '🇫🇯',

                // South America
                'America/Sao_Paulo': '🇧🇷', 'America/Argentina/Buenos_Aires': '🇦🇷', 'America/Lima': '🇵🇪',
                'America/Santiago': '🇨🇱', 'America/Bogota': '🇨🇴', 'America/Caracas': '🇻🇪',
                'America/Guayaquil': '🇪🇨', 'America/La_Paz': '🇧🇴', 'America/Montevideo': '🇺🇾',
                'America/Asuncion': '🇵🇾',

                // Central America & Caribbean
                'America/Havana': '🇨🇺', 'America/Jamaica': '🇯🇲', 'America/Santo_Domingo': '🇩🇴',
                'America/Costa_Rica': '🇨🇷', 'America/Panama': '🇵🇦', 'America/Guatemala': '🇬🇹'
            };
            return timezoneToFlag[timezone] || '🌍';
        }

        // Select location and update display
        function selectLocation(cityName, timezone, flag, country = null) {
            try {
                console.log('🌍 Selecting location:', cityName, 'Flag:', flag);
                
                // Update main clock data
                window.timelyAppState.currentLocationData = {
                    name: cityName,
                    city: cityName,
                    timezone: timezone,
                    flag: flag,
                    country: country || getCountryFromTimezone(timezone) || 'Selected Location'
                };
                
                // Update UI elements directly with enhanced flag support
                const locationFlag = document.getElementById('locationFlag');
                const locationName = document.getElementById('locationName');
                const locationCountry = document.getElementById('locationCountry');
                
                if (locationFlag) {
                    locationFlag.textContent = flag || '🌍';
                    locationFlag.setAttribute('data-country-code', getFlagCountryCode(flag));
                    locationFlag.title = `${country || cityName} Flag`;
                    console.log('🚩 Flag updated to:', flag, 'Code:', getFlagCountryCode(flag));
                }
                if (locationName) locationName.textContent = cityName;
                if (locationCountry) locationCountry.textContent = country || getCountryFromTimezone(timezone) || 'Selected Location';
                
                // Save to localStorage
                try {
                    localStorage.setItem('selectedLocation', JSON.stringify(window.timelyAppState.currentLocationData));
                } catch (error) {
                    console.log('localStorage not available:', error);
                }
                
                // Close modal
                toggleLocationPicker();
                
                // Start/restart the clock
                startClockUpdates(window.timelyAppState.currentLocationData);
                
                showNotification(`Location changed to ${flag} ${cityName}`, 'success');
            } catch (error) {
                console.error('Error selecting location:', error);
                showNotification('Error changing location', 'error');
            }
        }

        // Get country from timezone
        function getCountryFromTimezone(timezone) {
            const timezoneMap = {
                'America/New_York': 'United States',
                'America/Los_Angeles': 'United States',
                'America/Chicago': 'United States',
                'America/Toronto': 'Canada',
                'America/Vancouver': 'Canada',
                'Europe/London': 'United Kingdom',
                'Europe/Paris': 'France',
                'Europe/Berlin': 'Germany',
                'Europe/Rome': 'Italy',
                'Asia/Tokyo': 'Japan',
                'Asia/Shanghai': 'China',
                'Asia/Seoul': 'South Korea',
                'Asia/Dubai': 'UAE',
                'Australia/Sydney': 'Australia'
            };
            return timezoneMap[timezone] || 'Selected Location';
        }

        // Update location display
        function updateLocationDisplay(locationData) {
            console.log('🔄 Updating location display with:', locationData);
            
            const locationFlag = document.getElementById('locationFlag');
            const locationName = document.getElementById('locationName');
            const locationCountry = document.getElementById('locationCountry');
            
            console.log('🏷️ Flag element found:', !!locationFlag);
            console.log('🏷️ Setting flag to:', locationData.flag);
            
            if (locationFlag) {
                // Set the emoji flag
                locationFlag.textContent = locationData.flag || '🌍';
                
                // Add country code as fallback
                const countryCode = getFlagCountryCode(locationData.flag);
                locationFlag.setAttribute('data-country-code', countryCode);
                
                // Add title for accessibility
                locationFlag.title = `${locationData.country} Flag`;
                
                console.log('✅ Flag set, element content now:', locationFlag.textContent);
                console.log('✅ Country code fallback:', countryCode);
            }
            if (locationName) {
                locationName.textContent = locationData.city;
            }
            if (locationCountry) {
                locationCountry.innerHTML = `${locationData.country} • <span class="live-time-label">🔴 Live Time</span>`;
            }
        }
        
        // Get country code from flag emoji for fallback
        function getFlagCountryCode(flagEmoji) {
            const flagToCode = {
                '🌍': 'US', '🌍': 'CA', '🌍': 'MX', '🌍': 'GB', '🌍': 'FR', 
                '🌍': 'DE', '🌍': 'IT', '🌍': 'ES', '🌍': 'NL', '🌍': 'SE',
                '🌍': 'NO', '🇩🇰': 'DK', '🇫🇮': 'FI', '🇦🇹': 'AT', '🇨🇭': 'CH',
                '🇧🇪': 'BE', '🇮🇪': 'IE', '🇵🇹': 'PT', '🇨🇿': 'CZ', '🇵🇱': 'PL',
                '🇭🇺': 'HU', '🌍': 'RU', '🇺🇦': 'UA', '🇹🇷': 'TR', '🇬🇷': 'GR',
                '🌍': 'JP', '🌍': 'CN', '🌍': 'KR', '🌍': 'SG', '🇭🇰': 'HK',
                '🇹🇼': 'TW', '🌍': 'IN', '🌍': 'TH', '🇵🇭': 'PH', '🇮🇩': 'ID',
                '🇲🇾': 'MY', '🌍': 'VN', '🌍': 'PK', '🇧🇩': 'BD', '🇱🇰': 'LK',
                '🌍': 'AE', '🇶🇦': 'QA', '🇰🇼': 'KW', '🇸🇦': 'SA', '🇮🇷': 'IR',
                '🇮🇶': 'IQ', '🇮🇱': 'IL', '🌍': 'AU', '🌍': 'NZ', '🇫🇯': 'FJ',
                '🌍': 'BR', '🌍': 'AR', '🇨🇱': 'CL', '🇨🇴': 'CO', '🇵🇪': 'PE',
                '🇪🇬': 'EG', '🇳🇬': 'NG', '🌍': 'ZA', '🇰🇪': 'KE', '🇲🇦': 'MA',
                '🌍': 'WORLD'
            };
            return flagToCode[flagEmoji] || 'XX';
        }

        // Start clock updates
        function startClockUpdates(locationData) {
            // Clear any existing interval
            if (window.timelyAppState.clockInterval) {
                clearInterval(window.timelyAppState.clockInterval);
            }
            
            const primaryTime = document.getElementById('primaryTime');
            const primaryDate = document.getElementById('primaryDate');
            const sunInfo = document.getElementById('sunInfo');
            
            function updateClock() {
                try {
                    const now = new Date();
                    
                    // Update time
                    if (primaryTime) {
                        const timeString = now.toLocaleTimeString('en-US', {
                            timeZone: locationData.timezone,
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        primaryTime.textContent = timeString;
                    }
                    
                    // Update date
                    if (primaryDate) {
                        const dateString = now.toLocaleDateString('en-US', {
                            timeZone: locationData.timezone,
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        primaryDate.textContent = dateString;
                    }
                    
                    // Update sun times (simplified)
                    if (sunInfo && locationData.coordinates) {
                        const sunTimes = calculateSunTimes(locationData.coordinates.lat, locationData.coordinates.lon, now);
                        sunInfo.textContent = `🌅 ${sunTimes.sunrise} 🌇 ${sunTimes.sunset} (${sunTimes.dayLength})`;
                    }
                } catch (error) {
                    console.error('Clock update error:', error);
                }
            }
            
            // Update immediately and then every second
            updateClock();
            window.timelyAppState.clockInterval = setInterval(updateClock, 1000);
            window.timelyAppState.isClockRunning = true;
        }

        // Calculate sun times (simplified)
        function calculateSunTimes(lat, lon, date) {
            try {
                const now = new Date(date);
                const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                const latRad = lat * Math.PI / 180;
                const declination = 23.45 * Math.PI / 180 * Math.sin(2 * Math.PI * (284 + dayOfYear) / 365);
                const hourAngle = Math.acos(-Math.tan(latRad) * Math.tan(declination));
                const solarNoon = 12 - (lon / 15);
                const sunriseHour = solarNoon - (hourAngle * 12 / Math.PI);
                const sunsetHour = solarNoon + (hourAngle * 12 / Math.PI);
                
                const sunrise = formatHour(sunriseHour);
                const sunset = formatHour(sunsetHour);
                const dayLengthHours = sunsetHour - sunriseHour;
                const dayLength = `${Math.floor(dayLengthHours)}h ${Math.floor((dayLengthHours % 1) * 60)}m`;
                
                return { sunrise, sunset, dayLength };
            } catch (error) {
                return { sunrise: '06:30', sunset: '18:45', dayLength: '12h 15m' };
            }
        }

        // Format hour as HH:MM
        function formatHour(hour) {
            const h = Math.floor(hour);
            const m = Math.floor((hour % 1) * 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        // Toggle location picker modal
        function toggleLocationPicker() {
            const modal = document.getElementById('locationPickerOverlay');
            const searchInput = document.getElementById('citySearchInput');
            const searchResults = document.getElementById('searchResults');
            
            if (modal.classList.contains('active')) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                window.timelyAppState.isModalOpen = false;
                // Clear search
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.style.display = 'none';
            } else {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                window.timelyAppState.isModalOpen = true;
                // Focus search input after animation
                setTimeout(() => {
                    if (searchInput) searchInput.focus();
                }, 300);
                
                // Update city times
                updateModalCityTimes();
            }
        }

        // Dedicated back button handler for modal
        function closeLocationModal() {
            console.log('Back button clicked'); // Debug log
            const modal = document.getElementById('locationPickerOverlay');
            if (modal && modal.classList.contains('active')) {
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                window.timelyAppState.isModalOpen = false;
                
                // Clear search input and results
                const searchInput = document.getElementById('citySearchInput');
                const searchResults = document.getElementById('searchResults');
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.style.display = 'none';
                
                console.log('Modal closed successfully'); // Debug log
            } else {
                console.log('Modal not found or not active'); // Debug log
            }
        }

        // Initialize back button event listener on page load
        document.addEventListener('DOMContentLoaded', function() {
            const backButton = document.querySelector('.modal-back-btn');
            if (backButton) {
                // Add event listener as backup to onclick
                backButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeLocationModal();
                });
                console.log('Back button event listener added');
            }

            // Add ESC key support to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('locationPickerOverlay');
                    if (modal && modal.classList.contains('active')) {
                        closeLocationModal();
                    }
                }
            });

            // Add click outside modal to close
            const modal = document.getElementById('locationPickerOverlay');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeLocationModal();
                    }
                });
            }
        });

        // Enhanced search cities function
        function searchCities(query) {
            const searchResults = document.getElementById('searchResults');
            const searchResultsList = document.getElementById('searchResultsList');
            const searchResultsHeader = document.getElementById('searchResultsHeader');
            
            if (!query || query.trim().length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            const filteredCities = globalCitiesDatabase.filter(city => 
                city.name.toLowerCase().includes(query.toLowerCase()) ||
                city.country.toLowerCase().includes(query.toLowerCase())
            );
            
            if (filteredCities.length > 0) {
                searchResults.style.display = 'block';
                searchResultsHeader.textContent = `${filteredCities.length} cities found`;
                
                searchResultsList.innerHTML = filteredCities.slice(0, 50).map(city => `
                    <div class="location-card" >
                        <span class="location-flag">${city.flag}</span>
                        <div class="location-info">
                            <div class="location-name">${city.name}</div>
                            <div class="location-country">${city.country}</div>
                        </div>
                        <div class="location-time" id="time-${city.name.toLowerCase().replace(/\s+/g, '')}">--:--</div>
                    </div>
                `).join('');
                
                // Update times for search results
                setTimeout(() => updateSearchResultTimes(filteredCities.slice(0, 50)), 100);
            } else {
                searchResults.style.display = 'block';
                searchResultsHeader.textContent = 'No cities found';
                searchResultsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🔍</div>
                        <div class="empty-state-title">No cities found</div>
                        <div class="empty-state-description">Try searching with a different city name or country</div>
                    </div>
                `;
            }
        }

        // Enhanced detect location function
        async function detectMyLocation() {
            const detectBtn = document.getElementById('detectLocationBtn');
            const originalContent = detectBtn.innerHTML;
            
            // Show loading state
            detectBtn.innerHTML = `
                <div class="loading-spinner"></div>
                <span class="text">Detecting...</span>
            `;
            detectBtn.disabled = true;
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by this browser');
                }
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 600000
                    });
                });
                
                const { latitude, longitude } = position.coords;
                
                // Use timezone API to get location info
                const response = await fetch(`https://api.ipgeolocation.io/timezone?apiKey=your-api-key&lat=${latitude}&long=${longitude}`);
                
                if (!response.ok) {
                    // Fallback to detecting timezone from browser
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const city = timezone.split('/').pop().replace(/_/g, ' ');
                    selectLocation(city, timezone, '🌍', 'Detected Location');
                    showNotification('Location detected successfully!', 'success');
                } else {
                    const data = await response.json();
                    selectLocation(data.city || 'Local Time', data.timezone, '🌍', data.country_name || 'Detected Location');
                    showNotification('Location detected successfully!', 'success');
                }
                
            } catch (error) {
                console.error('Location detection failed:', error);
                
                // Fallback to browser timezone
                try {
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const city = timezone.split('/').pop().replace(/_/g, ' ');
                    selectLocation(city, timezone, '🌍', 'Local Time');
                    showNotification('Using browser timezone', 'info');
                } catch (fallbackError) {
                    showNotification('Location detection failed. Please select manually.', 'error');
                }
            } finally {
                // Restore button
                detectBtn.innerHTML = originalContent;
                detectBtn.disabled = false;
            }
        }

        // Update modal city times
        function updateModalCityTimes() {
            const timeElements = document.querySelectorAll('[id^="time-"]');
            timeElements.forEach(element => {
                const cityId = element.id.replace('time-', '');
                const timezone = getCityTimezone(cityId);
                if (timezone) {
                    try {
                        const time = new Date().toLocaleTimeString('en-US', {
                            timeZone: timezone,
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        element.textContent = time;
                    } catch (error) {
                        element.textContent = '--:--';
                    }
                }
            });
        }

        // Update search result times
        function updateSearchResultTimes(cities) {
            cities.forEach(city => {
                const timeElement = document.getElementById(`time-${city.name.toLowerCase().replace(/\s+/g, '')}`);
                if (timeElement) {
                    try {
                        const time = new Date().toLocaleTimeString('en-US', {
                            timeZone: city.timezone,
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        timeElement.textContent = time;
                    } catch (error) {
                        timeElement.textContent = '--:--';
                    }
                }
            });
        }

        // Get timezone for city ID
        function getCityTimezone(cityId) {
            const timezoneMap = {
                'newyork': 'America/New_York',
                'losangeles': 'America/Los_Angeles',
                'chicago': 'America/Chicago',
                'toronto': 'America/Toronto',
                'vancouver': 'America/Vancouver',
                'london': 'Europe/London',
                'paris': 'Europe/Paris',
                'berlin': 'Europe/Berlin',
                'rome': 'Europe/Rome',
                'tokyo': 'Asia/Tokyo',
                'shanghai': 'Asia/Shanghai',
                'dubai': 'Asia/Dubai',
                'singapore': 'Asia/Singapore',
                'sydney': 'Australia/Sydney',
                'auckland': 'Pacific/Auckland'
            };
            return timezoneMap[cityId];
        }

        // Start the main clock
        function startClock() {
            // Clear existing interval
            if (window.timelyAppState.clockInterval) {
                clearInterval(window.timelyAppState.clockInterval);
            }
            
            const updateTime = () => {
                try {
                    const locationData = window.timelyAppState.currentLocationData;
                    const timezone = locationData ? locationData.timezone : Intl.DateTimeFormat().resolvedOptions().timeZone;
                    
                    const now = new Date();
                    const timeElement = document.getElementById('primaryTime');
                    const dateElement = document.getElementById('primaryDate');
                    
                    if (timeElement) {
                        const time = now.toLocaleTimeString('en-US', {
                            timeZone: timezone,
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        timeElement.textContent = time;
                    }
                    
                    if (dateElement) {
                        const date = now.toLocaleDateString('en-US', {
                            timeZone: timezone,
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        dateElement.textContent = date;
                    }
                    
                } catch (error) {
                    console.error('Error updating time:', error);
                }
            };
            
            // Update immediately and then every second
            updateTime();
            window.timelyAppState.clockInterval = setInterval(updateTime, 1000);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText =
                'position: fixed;\n'
                + 'top: 20px;\n'
                + 'right: 20px;\n'
                + 'background: ' + (type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6') + ';\n'
                + 'color: white;\n'
                + 'padding: 12px 20px;\n'
                + 'border-radius: 25px;\n'
                + 'font-weight: 600;\n'
                + 'font-size: 14px;\n'
                + 'box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);\n'
                + 'cursor: pointer;\n'
                + 'z-index: 10000;\n'
                + 'animation: pulse 2s infinite;';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Initialize application
        function initializeApp() {
            console.log('🚀 Initializing app...');
            
            // Load saved location
            let savedLocation = null;
            try {
                const savedLocationData = localStorage.getItem('selectedLocation');
                if (savedLocationData) {
                    savedLocation = JSON.parse(savedLocationData);
                    console.log('📍 Loaded saved location:', savedLocation);
                }
            } catch (error) {
                console.log('Could not load saved location:', error);
            }
            
            if (savedLocation && savedLocation.city && savedLocation.timezone) {
                console.log('✅ Using saved location:', savedLocation.city, savedLocation.flag);
                updateLocationDisplay(savedLocation);
                window.timelyAppState.currentLocationData = savedLocation;
                startClockUpdates(savedLocation);
            } else {
                // Start with local timezone
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const parts = timezone.split('/');
                const city = parts[parts.length - 1].replace(/_/g, ' ');
                
                // Try to get a better flag based on common timezone patterns
                const flag = getTimezoneFlag(timezone);
                console.log('🌍 Default timezone:', timezone, 'Flag:', flag);
                
                const defaultLocation = {
                    city: city,
                    country: 'Your Local Time',
                    timezone: timezone,
                    flag: flag
                };
                
                console.log('🔄 Setting default location:', defaultLocation);
                updateLocationDisplay(defaultLocation);
                window.timelyAppState.currentLocationData = defaultLocation;
                startClockUpdates(defaultLocation);
            }
        }

        // Update city card times
        function updateCityCardTimes() {
            const cityCards = [
                { id: 'time-newyork', timezone: 'America/New_York' },
                { id: 'time-losangeles', timezone: 'America/Los_Angeles' },
                { id: 'time-toronto', timezone: 'America/Toronto' },
                { id: 'time-london', timezone: 'Europe/London' },
                { id: 'time-paris', timezone: 'Europe/Paris' },
                { id: 'time-berlin', timezone: 'Europe/Berlin' },
                { id: 'time-rome', timezone: 'Europe/Rome' },
                { id: 'time-tokyo', timezone: 'Asia/Tokyo' },
                { id: 'time-shanghai', timezone: 'Asia/Shanghai' },
                { id: 'time-dubai', timezone: 'Asia/Dubai' },
                { id: 'time-sydney', timezone: 'Australia/Sydney' },
                { id: 'time-auckland', timezone: 'Pacific/Auckland' }
            ];

            const now = new Date();

            cityCards.forEach(card => {
                // Update both .location-time and .city-time elements
                const element1 = document.getElementById(card.id); // for .location-time
                const element2 = document.querySelector('.city-time#' + card.id); // for city cards
                let timeString = '--:--';
                try {
                    timeString = now.toLocaleTimeString('en-US', {
                        timeZone: card.timezone,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (error) {
                    // fallback already set
                }
                if (element1) element1.textContent = timeString;
                if (element2) element2.textContent = timeString;
            });
        }

        // Start city card time updates
        function startCityCardUpdates() {
            // Update immediately
            updateCityCardTimes();
            
            // Update every minute (since we only show hours:minutes)
            setInterval(updateCityCardTimes, 60000);
        }

        // ===== FAVORITE CLOCKS FUNCTIONALITY =====
        
        // Universal function to add any city to favorites from city cards
        function addCityToFavorites(event, cityName, timezone, flag, country) {
            event.stopPropagation(); // Prevent card click
            
            const success = addToFavorites(cityName, timezone, flag, country);
            
            // Add visual feedback
            if (success) {
                const btn = event.target;
                btn.classList.add('added');
                setTimeout(() => btn.classList.remove('added'), 500);
            }
        }
        
        // Add city to favorites
        function addToFavorites(cityName, timezone, flag, country) {
            // Always resolve the correct flag for the timezone if missing or generic
            let resolvedFlag = flag;
            if (!flag || flag === '🌍') {
                resolvedFlag = getTimezoneFlag(timezone);
            }
            const favoriteCity = {
                name: cityName,
                timezone: timezone,
                flag: resolvedFlag,
                country: country,
                id: `favorite-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
            };
            
            // Check if city is already in favorites
            const exists = window.timelyAppState.favoriteClocks.find(
                fav => fav.name === cityName && fav.timezone === timezone
            );
            
            if (exists) {
                showNotification(`⭐ ${cityName} is already in your favorites!`, 'info');
                return false;
            }
            
            // Add to favorites
            window.timelyAppState.favoriteClocks.push(favoriteCity);
            
            // Save to localStorage
            localStorage.setItem('favoriteClocks', JSON.stringify(window.timelyAppState.favoriteClocks));
            
            // Update display
            renderFavoriteClocks();
            showNotification(`⭐ Added ${cityName} to favorites!`, 'success');
            
            // Close the location picker modal for better UX
            const modal = document.getElementById('locationPickerOverlay');
            if (modal && modal.classList.contains('active')) {
                setTimeout(() => {
                    // Clear search input and hide results for clean state
                    const searchInput = document.getElementById('citySearchInput');
                    const searchResults = document.getElementById('searchResults');
                    
                    if (searchInput) {
                        searchInput.value = '';
                        searchInput.placeholder = '🔍 Search cities worldwide (e.g., New York, London, Tokyo)...';
                    }
                    if (searchResults) {
                        searchResults.style.display = 'none';
                    }
                    
                    // Add a subtle closing animation class
                    modal.style.opacity = '0.7';
                    setTimeout(() => {
                        modal.style.opacity = ''; // Reset opacity
                        toggleLocationPicker();
                    }, 200);
                    
                }, 600); // Reduced delay slightly for better responsiveness
            }
            
            return true;
        }
        
        // Remove city from favorites
        function removeFromFavorites(cityId) {
            const cityIndex = window.timelyAppState.favoriteClocks.findIndex(fav => fav.id === cityId);
            
            if (cityIndex > -1) {
                const cityName = window.timelyAppState.favoriteClocks[cityIndex].name;
                window.timelyAppState.favoriteClocks.splice(cityIndex, 1);
                
                // Clear interval for this clock
                if (window.timelyAppState.favoriteClockIntervals[cityId]) {
                    clearInterval(window.timelyAppState.favoriteClockIntervals[cityId]);
                    delete window.timelyAppState.favoriteClockIntervals[cityId];
                }
                
                // Save to localStorage
                localStorage.setItem('favoriteClocks', JSON.stringify(window.timelyAppState.favoriteClocks));
                
                // Update display
                renderFavoriteClocks();
                showNotification(`🗑️ Removed ${cityName} from favorites`, 'success');
            }
        }
        
        // Render favorite clocks
        function renderFavoriteClocks() {
            const favoriteSection = document.getElementById('favoriteClockSection');
            const favoriteGrid = document.getElementById('favoriteClockGrid');
            
            if (window.timelyAppState.favoriteClocks.length === 0) {
                favoriteSection.style.display = 'none';
                return;
            }
            
            favoriteSection.style.display = 'block';
            
            favoriteGrid.innerHTML = window.timelyAppState.favoriteClocks.map(fav => `
                <div class="favorite-clock-card" id="${fav.id}">
                    <div class="favorite-clock-header">
                        <div class="favorite-city-info">
                            <h3 class="favorite-city-name">${fav.name}</h3>
                            <p class="favorite-city-country">
                                <span class="favorite-city-flag">${fav.flag}</span>
                                ${fav.country}
                            </p>
                        </div>
                        <button class="remove-favorite-btn" 
                                onclick="removeFromFavorites('${fav.id}')"
                                title="Remove from favorites">
                            ×
                        </button>
                    </div>
                    <div class="favorite-clock-time" id="time-${fav.id}">--:--:--</div>
                    <div class="favorite-clock-date" id="date-${fav.id}">Loading...</div>
                    <div class="favorite-timezone-info">${fav.timezone}</div>
                </div>
            `).join('');
            
            // Start updating times for favorite clocks
            startFavoriteClockUpdates();
        }
        
        // Update times for all favorite clocks
        function updateFavoriteClockTimes() {
            window.timelyAppState.favoriteClocks.forEach(fav => {
                try {
                    const now = new Date();
                    const timeElement = document.getElementById(`time-${fav.id}`);
                    const dateElement = document.getElementById(`date-${fav.id}`);
                    
                    if (timeElement && dateElement) {
                        const timeInTimezone = new Intl.DateTimeFormat('en-US', {
                            timeZone: fav.timezone,
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit',
                            hour12: false
                        }).format(now);
                        
                        const dateInTimezone = new Intl.DateTimeFormat('en-US', {
                            timeZone: fav.timezone,
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        }).format(now);
                        
                        timeElement.textContent = timeInTimezone;
                        dateElement.textContent = dateInTimezone;
                    }
                } catch (error) {
                    console.error(`Error updating time for ${fav.name}:`, error);
                }
            });
        }
        
        // Start favorite clock updates
        function startFavoriteClockUpdates() {
            // Clear existing intervals
            Object.values(window.timelyAppState.favoriteClockIntervals).forEach(clearInterval);
            window.timelyAppState.favoriteClockIntervals = {};
            
            // Update immediately
            updateFavoriteClockTimes();
            
            // Set up interval for updates every second
            const mainInterval = setInterval(updateFavoriteClockTimes, 1000);
            window.timelyAppState.favoriteClockIntervals['main'] = mainInterval;
        }

        // Function to add favorite buttons to all city cards
        function addFavoriteButtonsToAllCards() {
            const allCityCards = document.querySelectorAll('.city-card');
            
            allCityCards.forEach(card => {
                const footer = card.querySelector('.city-card-footer');
                const cityName = card.querySelector('.city-name')?.textContent;
                const cityCountry = card.querySelector('.city-country')?.textContent;
                const cityFlag = card.querySelector('.city-flag')?.textContent;
                
                // Skip if button already exists or if we can't find required info
                if (!footer || !cityName || !cityCountry || footer.querySelector('.quick-favorite-btn')) {
                    return;
                }
                
                // Extract timezone and country from onclick attribute
                const onclickAttr = card.getAttribute('onclick');
                if (!onclickAttr) return;
                
                // Parse the onclick to extract timezone and flag
                const matches = onclickAttr.match(/selectLocation\('([^']+)',\s*'([^']+)',\s*'([^']+)'\)/);
                if (!matches) return;
                
                const [, name, timezone, flag] = matches;
                
                // Create favorite button
                const favoriteBtn = document.createElement('button');
                favoriteBtn.className = 'quick-favorite-btn';
                favoriteBtn.innerHTML = '⭐';
                favoriteBtn.title = 'Add to favorites';
                favoriteBtn.onclick = (event) => {
                    event.stopPropagation();
                    const success = addToFavorites(name, timezone, flag, cityCountry);
                    
                    // Add visual feedback
                    if (success) {
                        favoriteBtn.classList.add('added');
                        setTimeout(() => favoriteBtn.classList.remove('added'), 500);
                    }
                };
                
                // Add button to footer
                footer.appendChild(favoriteBtn);
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the app
            setTimeout(initializeApp, 100);
            
            // Start city card time updates
            setTimeout(startCityCardUpdates, 200);
            
            // Initialize favorite clocks
            setTimeout(renderFavoriteClocks, 300);
            
            // Add favorite buttons to all city cards
            setTimeout(addFavoriteButtonsToAllCards, 400);
            
            // Close modal when clicking outside
            document.addEventListener('click', (e) => {
                const modal = document.getElementById('locationPickerOverlay');
                if (modal && modal.classList.contains('active') && e.target === modal) {
                    toggleLocationPicker();
                }
            });
            
            // Enter key support for search
            const searchInput = document.getElementById('citySearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const query = e.target.value.trim();
                        const city = globalCitiesDatabase.find(c => 
                            c.name.toLowerCase() === query.toLowerCase() ||
                            c.name.toLowerCase().includes(query.toLowerCase())
                        );
                        if (city) {
                            selectLocation(city.name, city.timezone, city.flag, city.country);
                        }
                    }
                });
            }
        });

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('TIMELY: Service Worker registered successfully:', registration.scope);
                    
                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New content is available
                                console.log('TIMELY: New content available');
                                showUpdateNotification(newWorker);
                            }
                        });
                    });
                } catch (error) {
                    console.error('TIMELY: Service Worker registration failed:', error);
                }
            });

            // Enhanced message handling from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                const { type, timestamp, version } = event.data;
                
                switch (type) {
                    case 'NETWORK_AVAILABLE':
                        console.log('TIMELY: Network available, syncing time');
                        if (typeof updateAllTimes === 'function') {
                            updateAllTimes();
                        }
                        showNotification('🌍 Back online! Times updated.', 'success', 3000);
                        break;
                    case 'PERIODIC_UPDATE':
                        console.log('TIMELY: Periodic update triggered');
                        if (typeof updateAllTimes === 'function') {
                            updateAllTimes();
                        }
                        break;
                    case 'SW_UPDATED':
                        console.log('TIMELY: Service Worker updated to version', version);
                        break;
                }
            });
        }

        // Enhanced PWA Installation
        window.deferredPrompt = null;
        let installPromptShown = false;

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('TIMELY: PWA install prompt available');
            e.preventDefault();
            window.deferredPrompt = e;
            
            // Show custom install button after a delay (better UX)
            if (!installPromptShown && !localStorage.getItem('pwa-install-dismissed')) {
                setTimeout(showPWAInstallPrompt, 5000);
            }
        });

        window.addEventListener('appinstalled', () => {
            console.log('TIMELY: PWA was installed');
            window.deferredPrompt = null;
            hidePWAInstallPrompt();
            showNotification('🎉 TIMELY installed successfully!', 'success');
            
            // Track installation
            if (typeof gtag !== 'undefined') {
                gtag('event', 'pwa_install', {
                    event_category: 'engagement',
                    event_label: 'PWA Installation'
                });
            }
        });

        function showPWAInstallPrompt() {
            if (!window.deferredPrompt || installPromptShown) return;
            
            installPromptShown = true;
            const installContainer = document.createElement('div');
            installContainer.className = 'install-pwa-container';
            installContainer.innerHTML = `
                <div class="install-pwa-btn" onclick="installPWA()">
                    <span>📱</span>
                    <span>Install App</span>
                </div>
            `;
            
            document.body.appendChild(installContainer);
            
            // Add dismiss button after 10 seconds
            setTimeout(() => {
                const dismissBtn = document.createElement('button');
                dismissBtn.innerHTML = '✕';
                dismissBtn.style.cssText = `
                    position: absolute;
                    top: -8px;
                    right: -8px;
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    border: none;
                    background: rgba(0,0,0,0.6);
                    color: white;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                `;
                dismissBtn.onclick = (e) => {
                    e.stopPropagation();
                    hidePWAInstallPrompt();
                    localStorage.setItem('pwa-install-dismissed', 'true');
                };
                installContainer.appendChild(dismissBtn);
            }, 10000);
        }

        function hidePWAInstallPrompt() {
            const installContainer = document.querySelector('.install-pwa-container');
            if (installContainer) {
                installContainer.remove();
            }
        }

        async function installPWA() {
            if (!window.deferredPrompt) {
                showNotification('Installation not available', 'error');
                return;
            }

            const result = await window.deferredPrompt.prompt();
            console.log('TIMELY: PWA install prompt result:', result.outcome);
            
            if (result.outcome === 'accepted') {
                console.log('TIMELY: User accepted PWA install');
            } else {
                console.log('TIMELY: User dismissed PWA install');
            }
            
            window.deferredPrompt = null;
            hidePWAInstallPrompt();
        }

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            const colors = {
                success: 'linear-gradient(135deg, #10b981, #059669)',
                error: 'linear-gradient(135deg, #ef4444, #dc2626)',
                warning: 'linear-gradient(135deg, #f59e0b, #d97706)',
                info: 'linear-gradient(135deg, #3b82f6, #2563eb)'
            };
            
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${colors[type] || colors.info};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                    z-index: 10000;
                    animation: slideInFromTop 0.5s ease;
                    max-width: 90%;
                    text-align: center;
                ">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutToTop 0.5s ease';
                    setTimeout(() => notification.remove(), 500);
                }
            }, duration);
        }

        function showUpdateNotification(newWorker) {
            const updateNotification = document.createElement('div');
            updateNotification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    z-index: 10000;
                    cursor: pointer;
                    animation: slideInFromTop 0.5s ease;
                ">
                    🔄 App Updated! Tap to reload
                </div>
            `;
            
            updateNotification.onclick = () => {
                newWorker.postMessage({ type: 'SKIP_WAITING' });
                window.location.reload();
            };
            
            document.body.appendChild(updateNotification);
            
            // Auto-hide after 15 seconds
            setTimeout(() => {
                if (updateNotification.parentNode) {
                    updateNotification.remove();
                }
            }, 15000);
        }

        // Enhanced background sync registration
        if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
            window.addEventListener('online', () => {
                navigator.serviceWorker.ready.then((registration) => {
                    registration.sync.register('time-sync');
                    registration.sync.register('cache-cleanup');
                });
            });
        }

        // Mobile performance optimizations
        document.addEventListener('DOMContentLoaded', () => {
            // Optimize viewport height for mobile browsers
            function setVH() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', setVH);
            
            // Prevent double-tap zoom on mobile
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (event) => {
                const now = new Date().getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Add touch feedback to interactive elements
            const interactiveElements = document.querySelectorAll('button, .clickable, .city-card, .location-card');
            interactiveElements.forEach(element => {
                element.addEventListener('touchstart', () => {
                    element.style.opacity = '0.7';
                });
                
                element.addEventListener('touchend', () => {
                    setTimeout(() => {
                        element.style.opacity = '';
                    }, 150);
                });
            });
            
            // Enhanced scroll performance
            if (CSS.supports('overscroll-behavior', 'none')) {
                document.body.style.overscrollBehavior = 'none';
            }
            
            // Load performance monitoring
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.entryType === 'measure') {
                            console.log(`TIMELY Performance: ${entry.name} took ${entry.duration.toFixed(2)}ms`);
                        }
                    }
                });
                observer.observe({ entryTypes: ['measure'] });
            }
        });

        // Haptic feedback for supported devices
        function triggerHapticFeedback(type = 'medium') {
            if ('vibrate' in navigator) {
                const patterns = {
                    light: [10],
                    medium: [50],
                    heavy: [100],
                    success: [50, 50, 50],
                    error: [100, 50, 100]
                };
                navigator.vibrate(patterns[type] || patterns.medium);
            }
        }

        // Enhanced gesture support
        let touchStartY = 0;
        let touchStartTime = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });
        
        document.addEventListener('touchmove', (e) => {
            const modal = document.querySelector('.modal-content');
            if (modal && modal.contains(e.target)) {
                const touchY = e.touches[0].clientY;
                const deltaY = touchY - touchStartY;
                
                // Pull-to-close gesture
                if (deltaY > 0 && modal.scrollTop === 0) {
                    const pullDistance = Math.min(deltaY / 3, 100);
                    modal.style.transform = `translateY(${pullDistance}px)`;
                    modal.style.opacity = Math.max(0.5, 1 - (pullDistance / 200));
                }
            }
        }, { passive: true });
        
        document.addEventListener('touchend', (e) => {
            const modal = document.querySelector('.modal-content');
            if (modal) {
                const touchY = e.changedTouches[0].clientY;
                const deltaY = touchY - touchStartY;
                const touchDuration = Date.now() - touchStartTime;
                
                // Reset modal position
                modal.style.transform = '';
                modal.style.opacity = '';
                
                // Close modal if pulled down significantly
                if (deltaY > 100 && touchDuration < 1000) {
                    const overlay = document.getElementById('locationPickerOverlay');
                    if (overlay && overlay.classList.contains('active')) {
                        toggleLocationPicker();
                        triggerHapticFeedback('light');
                    }
                }
            }
        }, { passive: true });

        // Mobile-First Location Picker Functions
        
        // Handle search input with debouncing and clear button
        function handleSearchInput(value) {
            const clearBtn = document.querySelector('.search-clear-btn');
            const searchInput = document.getElementById('citySearchInput');
            
            if (value.length > 0) {
                clearBtn.style.display = 'flex';
            } else {
                clearBtn.style.display = 'none';
            }
            
            // Debounce search to improve performance
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                if (value.length > 0) {
                    performSearch(value);
                } else {
                    showPopularLocations();
                }
            }, 300);
        }

        // Clear search input
        function clearSearch() {
            const searchInput = document.getElementById('citySearchInput');
            const clearBtn = document.querySelector('.search-clear-btn');
            
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchInput.focus();
            showPopularLocations();
        }

        // Use current location with loading state
        async function useCurrentLocation() {
            const btn = document.getElementById('currentLocationBtn');
            const spinner = btn.querySelector('.loading-spinner');
            const btnText = btn.querySelector('.btn-text');
            const gpsIcon = btn.querySelector('.gps-icon');

            // Show loading state
            btn.disabled = true;
            spinner.style.display = 'block';
            btnText.textContent = 'Getting location...';
            gpsIcon.style.display = 'none';

            try {
                if (!navigator.geolocation) {
                    showNotification('Geolocation is not supported by your browser.', 'error');
                    throw new Error('Geolocation not supported');
                }


                let position;
                try {
                    position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        });
                    });
                } catch (error) {
                    // Permission denied or unavailable: fallback to browser timezone
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const city = timezone.split('/').pop().replace(/_/g, ' ');
                    const flag = getTimezoneFlag(timezone);
                    selectLocation(city, timezone, flag, 'Browser Timezone');
                    showNotification('Location permission denied. Showing time based on your browser settings.', 'warning');
                    return;
                }

                const { latitude, longitude } = position.coords;

                // Use BigDataCloud reverse-geocode-client API (free, no key required)
                let data;
                try {
                    const apiUrl = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`;
                    const response = await fetch(apiUrl);
                    if (!response.ok) throw new Error('Failed to fetch location info');
                    data = await response.json();
                } catch (apiError) {
                    showNotification('Could not get city/country from coordinates. Using browser timezone.', 'warning');
                    data = {};
                }

                const timezone = data.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
                const city = data.city || data.locality || data.principalSubdivision || 'Current Location';
                const country = data.countryName || 'Current Location';
                const flag = getTimezoneFlag(timezone);

                selectLocation(city, timezone, flag, country);

            } catch (error) {
                console.error('Location detection failed:', error);

                // Show error state
                btnText.textContent = 'Location unavailable';
                setTimeout(() => {
                    btnText.textContent = 'Use Current Location';
                    gpsIcon.style.display = 'inline';
                }, 2000);

                // Only show generic notification if not already shown
                if (!error.message || error.message === 'Location detection failed') {
                    showNotification('Unable to get your location. Please select manually.', 'error');
                }
            } finally {
                // Reset button state
                btn.disabled = false;
                spinner.style.display = 'none';
                if (btnText.textContent === 'Getting location...') {
                    btnText.textContent = 'Use Current Location';
                    gpsIcon.style.display = 'inline';
                }
            }
        }

        // Show popular locations in mobile-friendly format
        function showPopularLocations() {
            const modalBody = document.querySelector('.modal-body');
            const selectedDisplay = document.getElementById('selectedLocationDisplay');
            
            // Show current selection if any
            const currentLocation = window.timelyAppState?.currentLocationData;
            if (currentLocation) {
                selectedDisplay.style.display = 'flex';
                document.getElementById('selectedFlag').textContent = currentLocation.flag || '🌍';
                document.getElementById('selectedName').textContent = currentLocation.city || currentLocation.name || 'Current Location';
                document.getElementById('selectedCountry').textContent = currentLocation.country || 'Selected Location';
            } else {
                selectedDisplay.style.display = 'none';
            }
            
            // Helper to get flag for each city
            const getFlag = (tz) => getTimezoneFlag ? getTimezoneFlag(tz) : '🌍';
            modalBody.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">Popular Cities</h3>
                </div>
                <div class="popular-cities-container">
                    <div class="location-card" onclick="selectMobileLocation('New York', 'America/New_York', '${getFlag('America/New_York')}', 'United States')">
                        <span class="location-flag">${getFlag('America/New_York')}</span>
                        <div class="location-info">
                            <div class="location-name">New York</div>
                            <div class="location-country">United States</div>
                        </div>
                        <div class="location-time" id="mobile-time-newyork">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('New York', 'America/New_York', '${getFlag('America/New_York')}', 'United States')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                    <div class="location-card" onclick="selectMobileLocation('London', 'Europe/London', '${getFlag('Europe/London')}', 'United Kingdom')">
                        <span class="location-flag">${getFlag('Europe/London')}</span>
                        <div class="location-info">
                            <div class="location-name">London</div>
                            <div class="location-country">United Kingdom</div>
                        </div>
                        <div class="location-time" id="mobile-time-london">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('London', 'Europe/London', '${getFlag('Europe/London')}', 'United Kingdom')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                    <div class="location-card" onclick="selectMobileLocation('Tokyo', 'Asia/Tokyo', '${getFlag('Asia/Tokyo')}', 'Japan')">
                        <span class="location-flag">${getFlag('Asia/Tokyo')}</span>
                        <div class="location-info">
                            <div class="location-name">Tokyo</div>
                            <div class="location-country">Japan</div>
                        </div>
                        <div class="location-time" id="mobile-time-tokyo">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('Tokyo', 'Asia/Tokyo', '${getFlag('Asia/Tokyo')}', 'Japan')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                    <div class="location-card" onclick="selectMobileLocation('Sydney', 'Australia/Sydney', '${getFlag('Australia/Sydney')}', 'Australia')">
                        <span class="location-flag">${getFlag('Australia/Sydney')}</span>
                        <div class="location-info">
                            <div class="location-name">Sydney</div>
                            <div class="location-country">Australia</div>
                        </div>
                        <div class="location-time" id="mobile-time-sydney">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('Sydney', 'Australia/Sydney', '${getFlag('Australia/Sydney')}', 'Australia')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                    <div class="location-card" onclick="selectMobileLocation('Dubai', 'Asia/Dubai', '${getFlag('Asia/Dubai')}', 'UAE')">
                        <span class="location-flag">${getFlag('Asia/Dubai')}</span>
                        <div class="location-info">
                            <div class="location-name">Dubai</div>
                            <div class="location-country">UAE</div>
                        </div>
                        <div class="location-time" id="mobile-time-dubai">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('Dubai', 'Asia/Dubai', '${getFlag('Asia/Dubai')}', 'UAE')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                    <div class="location-card" onclick="selectMobileLocation('Los Angeles', 'America/Los_Angeles', '${getFlag('America/Los_Angeles')}', 'United States')">
                        <span class="location-flag">${getFlag('America/Los_Angeles')}</span>
                        <div class="location-info">
                            <div class="location-name">Los Angeles</div>
                            <div class="location-country">United States</div>
                        </div>
                        <div class="location-time" id="mobile-time-losangeles">--:--</div>
                        <button class="add-to-favorites-btn" onclick="event.stopPropagation(); addToFavorites('Los Angeles', 'America/Los_Angeles', '${getFlag('America/Los_Angeles')}', 'United States')" title="Add to Favorites">⭐ Add to Favorites</button>
                    </div>
                </div>
            `;
            
            // Update times for popular cities
            updateMobileCityTimes();
        }

        // Select location with mobile-friendly feedback
        function selectMobileLocation(cityName, timezone, flag, country) {
            // Add tap feedback
            const clickedCard = event.currentTarget;
            clickedCard.style.transform = 'scale(0.96)';
            
            setTimeout(() => {
                clickedCard.style.transform = '';
                selectLocation(cityName, timezone, flag, country);
            }, 150);
        }

        // Update times for mobile city cards
        function updateMobileCityTimes() {
            const timeElements = document.querySelectorAll('[id^="mobile-time-"]');
            timeElements.forEach(element => {
                const cityId = element.id.replace('mobile-time-', '');
                const timezone = getCityTimezone(cityId);
                if (timezone) {
                    try {
                        const time = new Date().toLocaleTimeString('en-US', {
                            timeZone: timezone,
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        element.textContent = time;
                    } catch (error) {
                        element.textContent = '--:--';
                    }
                }
            });
        }

        // Perform search with mobile-friendly results
        function performSearch(query) {
            const results = globalCitiesDatabase.filter(city => 
                city.name.toLowerCase().includes(query.toLowerCase()) ||
                city.country.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 10); // Limit results for performance

            const modalBody = document.querySelector('.modal-body');
            
            if (results.length === 0) {
                modalBody.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: var(--modal-text-secondary);">
                        <div style="font-size: 24px; margin-bottom: 12px;">🔍</div>
                        <div style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">No cities found</div>
                        <div style="font-size: 14px;">Try a different search term</div>
                    </div>
                `;
                return;
            }

            const resultsHTML = results.map(city => `
                <div class="location-card search-result-card">
                    <span class="location-flag">${city.flag}</span>
                    <div class="location-info" onclick="selectMobileLocation('${city.name}', '${city.timezone}', '${city.flag}', '${city.country}')">
                        <div class="location-name">${city.name}</div>
                        <div class="location-country">${city.country}</div>
                    </div>
                    <button class="add-to-favorites-btn" 
                            onclick="event.stopPropagation(); addToFavorites('${city.name}', '${city.timezone}', '${city.flag}', '${city.country}')"
                            title="Add to Favorites">
                        ⭐ Add to Favorites
                    </button>
                </div>
            `).join('');

            modalBody.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">Search Results 
                        <span style="background: linear-gradient(45deg, #ff6b6b, #ff8e53); color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; margin-left: 8px;">
                            ${results.length} cities found
                        </span>
                    </h3>
                </div>
                <div class="search-results-container">
                    ${resultsHTML}
                </div>
            `;
        }

        // Initialize mobile location picker when modal opens
        function toggleLocationPicker() {
            const overlay = document.getElementById('locationPickerOverlay');
            const isActive = overlay.classList.contains('active');
            
            if (isActive) {
                overlay.classList.remove('active');
            } else {
                overlay.classList.add('active');
                showPopularLocations();
                
                // Focus search input for better UX
                setTimeout(() => {
                    const searchInput = document.getElementById('citySearchInput');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 300);
            }
        }

        // Initialize mobile features when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Set up keyboard event listeners
            const searchInput = document.getElementById('citySearchInput');
            if (searchInput) {
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        toggleLocationPicker();
                    }
                });
            }
            
            // Set up backdrop click to close
            const overlay = document.getElementById('locationPickerOverlay');
            if (overlay) {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        toggleLocationPicker();
                    }
                });
            }
            
            // Update mobile city times every minute
            setInterval(updateMobileCityTimes, 60000);
        });
    </script>
</body>
</html>












